<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic CPA AI - Your Financial Private Investigator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
        }

        a {
            color: #58a6ff;
            text-decoration: none;
        }

        a:hover {
            color: #79c0ff;
            text-decoration: underline;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #161b22;
            border-right: 1px solid #30363d;
            z-index: 100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar .brand {
            padding: 18px 16px;
            border-bottom: 1px solid #30363d;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .sidebar .brand h5 {
            color: #58a6ff;
            margin: 0;
            font-weight: 700;
            font-size: 1rem;
        }

        .sidebar .brand small {
            color: #8b949e;
            font-size: 0.7rem;
        }

        .sidebar .nav-link {
            color: #8b949e;
            padding: 10px 16px;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar .nav-link:hover {
            color: #c9d1d9;
            background: #1c2333;
        }

        .sidebar .nav-link.active {
            color: #58a6ff;
            background: #1c2333;
            border-left-color: #58a6ff;
            font-weight: 600;
        }

        .sidebar .nav-link i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 12px;
            border-top: 1px solid #30363d;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px 24px;
            min-height: 100vh;
        }

        /* Cards */
        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .stat-card:hover {
            border-color: #58a6ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stat-card .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .stat-card .stat-label {
            font-size: 0.72rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .stat-card.danger .stat-value {
            color: #f85149;
        }

        .stat-card.success .stat-value {
            color: #3fb950;
        }

        .stat-card.warning .stat-value {
            color: #d29922;
        }

        .stat-card.info .stat-value {
            color: #58a6ff;
        }

        .stat-card.purple .stat-value {
            color: #bc8cff;
        }

        .card-dark {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        .card-dark .card-header {
            background: #1c2333;
            border-bottom: 1px solid #30363d;
            padding: 10px 16px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tables */
        .table-dark-custom {
            background: transparent;
            color: #c9d1d9;
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        .table-dark-custom th {
            background: #1c2333;
            border-color: #30363d;
            color: #8b949e;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 8px 10px;
        }

        .table-dark-custom td {
            border-color: #21262d;
            vertical-align: middle;
            padding: 6px 10px;
        }

        .table-dark-custom tr:hover td {
            background: #e8d44d !important;
            color: #000 !important;
        }

        .table-dark-custom tr:hover td * {
            color: #000 !important;
        }

        .table-dark-custom tr:hover td .badge {
            color: #fff !important;
        }

        .table-dark-custom tr:hover td select {
            background: #fff;
            color: #000;
            border-color: #999;
        }

        .table-dark-custom tr:hover td code {
            color: #000 !important;
        }

        .table-dark-custom tr:hover td .btn {
            color: #000 !important;
            border-color: #666 !important;
        }

        .table-dark-custom tr.clickable-row {
            cursor: pointer;
        }

        .table-dark-custom tr.clickable-row:hover td {
            background: #e8d44d !important;
            color: #000 !important;
        }

        .amount-negative {
            color: #f85149;
            font-weight: 600;
        }

        .amount-positive {
            color: #3fb950;
            font-weight: 600;
        }

        .amount-zero {
            color: #8b949e;
        }

        /* Badges */
        .badge-personal {
            background: #fd7e14;
        }

        .badge-business {
            background: #1f6feb;
        }

        .badge-transfer {
            background: #da3633;
        }

        .badge-deposit {
            background: #238636;
        }

        .badge-fee {
            background: #d29922;
            color: #000;
        }

        .badge-flagged {
            background: #f85149;
            animation: pulse 2s infinite;
        }

        .badge-venmo {
            background: #3d95ce;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Filters */
        .filter-bar {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 14px;
        }

        .filter-bar .form-control,
        .filter-bar .form-select {
            background: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .filter-bar .form-control:focus,
        .filter-bar .form-select:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
        }

        /* Upload */
        .upload-zone {
            border: 2px dashed #30363d;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.05);
        }

        .upload-zone i.upload-icon {
            font-size: 2.5rem;
            color: #30363d;
            margin-bottom: 12px;
        }

        .upload-zone:hover i.upload-icon {
            color: #58a6ff;
        }

        /* Forms */
        .form-control,
        .form-select {
            background: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .form-control:focus,
        .form-select:focus {
            background: #0d1117;
            border-color: #58a6ff;
            color: #c9d1d9;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
        }

        .modal-content {
            background: #161b22;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .modal-header {
            border-color: #30363d;
        }

        .modal-footer {
            border-color: #30363d;
        }

        .btn-outline-light {
            border-color: #30363d;
            color: #c9d1d9;
        }

        .btn-outline-light:hover {
            background: #30363d;
            color: #fff;
        }

        .scrollable-table {
            max-height: 60vh;
            overflow-y: auto;
        }

        .scrollable-table-sm {
            max-height: 35vh;
            overflow-y: auto;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .category-select {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.76rem;
            max-width: 160px;
        }

        .checkbox-cell {
            width: 28px;
            text-align: center;
        }

        .drill-breadcrumb {
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 12px;
        }

        .drill-breadcrumb a {
            cursor: pointer;
        }

        .drill-breadcrumb .sep {
            margin: 0 6px;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Drill-down panel */
        .drill-panel {
            background: #1c2333;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .drill-panel .close-drill {
            cursor: pointer;
            color: #8b949e;
            float: right;
        }

        .drill-panel .close-drill:hover {
            color: #f85149;
        }

        .mini-bar {
            display: inline-block;
            height: 10px;
            border-radius: 2px;
            margin-right: 2px;
            vertical-align: middle;
        }

        /* Account cards */
        .account-card {
            border-left: 3px solid #58a6ff;
            padding-left: 12px;
            margin-bottom: 12px;
        }

        .account-card.bank {
            border-left-color: #3fb950;
        }

        .account-card.credit {
            border-left-color: #f85149;
        }

        .account-card.venmo {
            border-left-color: #3d95ce;
        }

        /* View Toggle Bar */
        .view-toggle-bar {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 4px;
            width: fit-content;
        }

        .view-toggle-bar .toggle-btn {
            padding: 6px 20px;
            border: none;
            background: transparent;
            color: #8b949e;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .view-toggle-bar .toggle-btn:hover {
            color: #c9d1d9;
            background: #1c2333;
        }

        .view-toggle-bar .toggle-btn.active {
            background: #58a6ff;
            color: #fff;
        }

        .view-toggle-bar .toggle-btn.active[data-mode="personal"] {
            background: #fd7e14;
        }

        .view-toggle-bar .toggle-btn.active[data-mode="business"] {
            background: #1f6feb;
        }

        /* Upload preview */
        .preview-panel {
            background: #1c2333;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .preview-panel .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        /* Proof docs in edit modal */
        .proof-section {
            border-top: 1px solid #30363d;
            padding-top: 10px;
            margin-top: 10px;
        }

        .proof-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.8rem;
        }

        .proof-item a {
            color: #58a6ff;
        }

        /* Suspicion score */
        .suspicion-bar {
            height: 8px;
            border-radius: 4px;
            background: #21262d;
            position: relative;
            overflow: hidden;
            min-width: 60px;
        }

        .suspicion-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .suspicion-low .suspicion-fill {
            background: #3fb950;
        }

        .suspicion-med .suspicion-fill {
            background: #d29922;
        }

        .suspicion-high .suspicion-fill {
            background: #f85149;
        }

        .risk-badge {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .risk-low {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
        }

        .risk-medium {
            background: rgba(210, 153, 34, 0.15);
            color: #d29922;
        }

        .risk-high {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }

        .duplicate-row {
            opacity: 0.5;
            background: rgba(210, 153, 34, 0.1) !important;
        }

        .duplicate-row td {
            text-decoration: line-through;
        }

        /* Rule suggestion toast */
        .rule-suggestion {
            background: #1c2333;
            border: 1px solid #58a6ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.82rem;
        }

        .rule-suggestion code {
            color: #79c0ff;
        }

        /* Executive summary */
        .finding-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 4px solid #30363d;
        }

        .finding-card.danger {
            border-left-color: #f85149;
        }

        .finding-card.warning {
            border-left-color: #d29922;
        }

        .finding-card.info {
            border-left-color: #58a6ff;
        }

        .finding-card .finding-title {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .finding-card .finding-detail {
            font-size: 0.78rem;
            color: #8b949e;
            margin-top: 2px;
        }

        .risk-gauge {
            width: 100%;
            height: 12px;
            background: #21262d;
            border-radius: 6px;
            overflow: hidden;
        }

        .risk-gauge-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Timeline bar */
        .timeline-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 0;
            font-size: 0.75rem;
        }

        .timeline-bar {
            display: flex;
            height: 16px;
            flex-shrink: 0;
            border-radius: 3px;
            overflow: hidden;
        }

        .timeline-bar .bar-in {
            background: #3fb950;
        }

        .timeline-bar .bar-out {
            background: #f85149;
        }

        .timeline-bar .bar-xfer {
            background: #d29922;
        }

        .timeline-flag {
            color: #f85149;
            font-size: 0.6rem;
        }

        /* Money flow */
        .flow-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
        }

        .flow-arrow {
            color: #58a6ff;
            font-size: 1.2rem;
            margin: 0 10px;
        }

        /* Quick date picks */
        .date-picks {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .date-picks .btn {
            font-size: 0.7rem;
            padding: 2px 8px;
        }

        /* Global search */
        .global-search-wrap {
            position: relative;
        }

        .global-search {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            padding: 6px 12px 6px 30px;
            font-size: 0.8rem;
            width: 100%;
        }

        .global-search:focus {
            border-color: #58a6ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
        }

        .global-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b949e;
            font-size: 0.75rem;
        }

        .global-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .global-results.show {
            display: block;
        }

        .global-result-item {
            padding: 8px 12px;
            border-bottom: 1px solid #21262d;
            cursor: pointer;
            font-size: 0.78rem;
        }

        .global-result-item:hover {
            background: #1c2333;
        }

        .global-result-section {
            padding: 4px 12px;
            font-size: 0.7rem;
            color: #8b949e;
            background: #0d1117;
            text-transform: uppercase;
            font-weight: 700;
        }

        /* Case notes */
        .note-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid #30363d;
        }

        .note-card.finding {
            border-left-color: #d29922;
        }

        .note-card.evidence {
            border-left-color: #f85149;
        }

        .note-card.timeline {
            border-left-color: #58a6ff;
        }

        .note-card .note-title {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .note-card .note-body {
            font-size: 0.82rem;
            color: #8b949e;
            margin-top: 6px;
            white-space: pre-wrap;
        }

        .note-card .note-meta {
            font-size: 0.7rem;
            color: #484f58;
            margin-top: 6px;
        }

        /* Alerts */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-bottom: 1px solid #21262d;
            cursor: pointer;
        }

        .alert-item:hover {
            background: #1c2333;
        }

        .alert-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .alert-icon.danger {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }

        .alert-icon.warning {
            background: rgba(210, 153, 34, 0.15);
            color: #d29922;
        }

        .alert-icon.info {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }

        .alert-count {
            font-size: 1.2rem;
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        /* Pagination */
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-controls .btn {
            padding: 2px 8px;
            font-size: 0.75rem;
        }

        .pagination-controls .btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Saved filters */
        .saved-filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #1c2333;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 3px 10px;
            font-size: 0.72rem;
            cursor: pointer;
            margin: 2px;
        }

        .saved-filter-chip:hover {
            border-color: #58a6ff;
        }

        .saved-filter-chip .del {
            color: #8b949e;
            margin-left: 4px;
        }

        .saved-filter-chip .del:hover {
            color: #f85149;
        }

        /* Quick comment */
        .quick-comment {
            font-size: 0.72rem;
            color: #8b949e;
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quick-comment-input {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.72rem;
            width: 140px;
        }

        /* Mobile hamburger */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            z-index: 150;
            padding: 0 12px;
            align-items: center;
            gap: 10px;
        }

        .mobile-header .hamburger {
            background: none;
            border: none;
            color: #c9d1d9;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 4px 8px;
        }

        .mobile-header .brand-text {
            color: #58a6ff;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 220px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 200;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.open {
                display: block;
            }

            .mobile-header {
                display: flex;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 60px 12px 12px !important;
            }

            .row.g-3>.col,
            .row.g-3>[class*="col-md-"] {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .stat-card .stat-value {
                font-size: 1.1rem;
            }

            .filter-bar .row {
                flex-direction: column;
            }

            .filter-bar .row .col {
                width: 100%;
            }
        }

        /* Print styles */
        @media print {

            .sidebar,
            .view-toggle-bar,
            .sidebar-footer,
            .filter-bar,
            .btn,
            button,
            .upload-zone,
            #upload-preview,
            .toast-container,
            .modal {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 10px !important;
            }

            body {
                background: #fff !important;
                color: #000 !important;
                font-size: 11pt !important;
            }

            .card-dark {
                background: #fff !important;
                border: 1px solid #ccc !important;
            }

            .card-dark .card-header {
                background: #f0f0f0 !important;
                color: #000 !important;
            }

            .table-dark-custom {
                color: #000 !important;
            }

            .table-dark-custom th {
                background: #e0e0e0 !important;
                color: #000 !important;
            }

            .table-dark-custom td {
                border-color: #ccc !important;
            }

            .table-dark-custom tr:hover td {
                background: transparent !important;
                color: #000 !important;
            }

            .stat-card {
                border: 1px solid #ccc !important;
                background: #f9f9f9 !important;
            }

            .stat-card .stat-value {
                color: #000 !important;
            }

            .amount-negative {
                color: #c00 !important;
            }

            .amount-positive {
                color: #060 !important;
            }

            .finding-card {
                background: #f9f9f9 !important;
            }

            .page-section {
                page-break-inside: avoid;
            }

            h4 {
                page-break-after: avoid;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <span class="brand-text"><i class="fas fa-search-dollar"></i> Forensic CPA AI</span>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="brand">
            <h5><i class="fas fa-search-dollar"></i> Forensic CPA AI</h5>
            <small>Your Financial Private Investigator</small>
            <!-- User info injected via JS to bypass caching -->
            <div id="sidebar-user-info"></div>
        </div>
        <!-- Global Search -->
        <div class="p-2">
            <div class="global-search-wrap">
                <i class="fas fa-search global-search-icon"></i>
                <input type="text" class="global-search" id="global-search" placeholder="Search everything..."
                    oninput="globalSearch(this.value)">
                <div class="global-results" id="global-results"></div>
            </div>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" data-page="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a>
            <a class="nav-link" href="#" data-page="alerts"><i class="fas fa-bell"></i> Alerts <span
                    class="badge bg-danger ms-auto" id="alert-badge" style="display:none;"></span></a>
            <a class="nav-link" href="#" data-page="transactions"><i class="fas fa-list-alt"></i> All Transactions</a>
            <a class="nav-link" href="#" data-page="analysis"><i class="fas fa-magnifying-glass-chart"></i> Forensic
                Analysis</a>
            <a class="nav-link" href="#" data-page="recipients"><i class="fas fa-user-secret"></i> Who Gets The
                Money</a>
            <a class="nav-link" href="#" data-page="deposit-aging"><i class="fas fa-clock"></i> Deposit Aging</a>
            <a class="nav-link" href="#" data-page="cardholders"><i class="fas fa-users"></i> Cardholder Compare</a>
            <a class="nav-link" href="#" data-page="money-flow"><i class="fas fa-project-diagram"></i> Money Flow</a>
            <a class="nav-link" href="#" data-page="timeline"><i class="fas fa-chart-line"></i> Timeline</a>
            <a class="nav-link" href="#" data-page="recurring"><i class="fas fa-redo"></i> Recurring Payments</a>
            <a class="nav-link" href="#" data-page="cardholder-timeline"><i class="fas fa-chart-area"></i> Cardholder
                Timeline</a>
            <a class="nav-link" href="#" data-page="case-notes"><i class="fas fa-sticky-note"></i> Case Notes</a>
            <a class="nav-link" href="#" data-page="accounts"><i class="fas fa-university"></i> Accounts</a>
            <a class="nav-link" href="#" data-page="upload"><i class="fas fa-cloud-upload-alt"></i> Upload</a>
            <a class="nav-link" href="#" data-page="documents"><i class="fas fa-folder-open"></i> Documents</a>
            <a class="nav-link" href="#" data-page="categories"><i class="fas fa-tags"></i> Rules</a>
            <a class="nav-link" href="#" data-page="audit-trail"><i class="fas fa-history"></i> Audit Trail</a>
            {% if enable_integrations %}
            <a class="nav-link" href="#" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
            {% endif %}
        </nav>
        <div class="sidebar-footer">
            <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="exportCSV()"><i
                    class="fas fa-download"></i> Export CSV</button>
            <button class="btn btn-info btn-sm w-100 mb-2" onclick="exportPDFReport()"><i class="fas fa-file-pdf"></i>
                Export PDF Report</button>
            <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="printReport()"><i class="fas fa-print"></i>
                Print Report</button>
            <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="recategorizeAll()"><i
                    class="fas fa-sync"></i> Re-categorize</button>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="clearAllData()"><i
                    class="fas fa-trash-alt"></i> Clear All Data</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Global Navigation & Breadcrumbs -->
        <div class="d-flex align-items-center mb-3 w-100">
            <button id="global-back-btn" class="btn btn-sm btn-outline-info d-none me-3" onclick="goBack()"
                title="Go Back backwards"
                style="border-radius: 50%; width: 32px; height: 32px; padding: 0; align-items: center; justify-content: center;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div id="global-breadcrumbs" style="display:none; margin-bottom: 0; flex-grow: 1;"></div>
            <div id="top-user-profile" class="ms-auto" style="display:none;"></div>
        </div>

        <!-- View Mode Toggle -->
        <div class="view-toggle-bar" id="view-toggle">
            <button class="toggle-btn active" data-mode="all" onclick="setViewMode('all')"><i
                    class="fas fa-globe me-1"></i>All</button>
            <button class="toggle-btn" data-mode="personal" onclick="setViewMode('personal')"><i
                    class="fas fa-user me-1"></i>Personal</button>
            <button class="toggle-btn" data-mode="business" onclick="setViewMode('business')"><i
                    class="fas fa-briefcase me-1"></i>Business</button>
        </div>

        <!-- ========== DASHBOARD ========== -->
        <div class="page-section active" id="page-dashboard">
            <h4 class="mb-1"><i class="fas fa-chart-pie text-info"></i> Dashboard</h4>
            <p class="text-muted small mb-3">Click any card or table row to drill down into the detail</p>

            <!-- Date Range Quick Picks -->
            <div class="date-picks" id="date-picks">
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('all')" data-preset="all">All
                    Time</button>
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('30')" data-preset="30">Last 30
                    Days</button>
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('90')" data-preset="90">Last 90
                    Days</button>
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('ytd')"
                    data-preset="ytd">YTD</button>
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('2024')"
                    data-preset="2024">2024</button>
                <button class="btn btn-sm btn-outline-light" onclick="setDateRange('2023')"
                    data-preset="2023">2023</button>
            </div>

            <!-- Executive Summary -->
            <div class="card-dark mb-3" id="executive-summary" style="display:none;">
                <div class="card-header" style="background:rgba(88,166,255,0.08);">
                    <span><i class="fas fa-clipboard-check me-1"></i> Investigation Summary</span>
                    <div class="d-flex align-items-center gap-2" id="risk-gauge-wrap"></div>
                </div>
                <div class="p-3" id="exec-findings"></div>
            </div>

            <!-- Summary Cards -->
            <div class="row g-3 mb-3" id="stats-cards"></div>

            <!-- Drill-down panel (appears when clicking stats) -->
            <div id="dashboard-drill" style="display:none;"></div>

            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-user me-1"></i> Spending by Cardholder</div>
                        <div class="scrollable-table-sm" id="dash-cardholder-table"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-tags me-1"></i> Spending by Category</div>
                        <div class="scrollable-table-sm" id="dash-category-table"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-flag text-danger me-1"></i> Recently Flagged</div>
                        <div class="scrollable-table-sm" id="dash-flagged-table"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Chart -->
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-chart-bar me-1"></i> Monthly Cash Flow</div>
                        <div class="p-2">
                            <div class="chart-container"><canvas id="monthly-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-chart-doughnut me-1"></i> Spending by Category</div>
                        <div class="p-2">
                            <div class="chart-container"><canvas id="category-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-12">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-table me-1"></i> Monthly Detail (click month to drill
                            down)</div>
                        <div class="scrollable-table-sm" id="dash-monthly"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TRANSACTIONS ========== -->
        <div class="page-section" id="page-transactions">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0"><i class="fas fa-list-alt text-info"></i> Transactions</h4>
                <div>
                    <button class="btn btn-sm btn-info me-1" onclick="showAddCategoryModal()"><i
                            class="fas fa-plus"></i> Add Category</button>
                    <button class="btn btn-sm btn-outline-light me-1" onclick="showAddTransactionModal()"><i
                            class="fas fa-plus"></i> Add Manual</button>
                    <button class="btn btn-sm btn-outline-danger me-1" id="bulk-delete-btn" style="display:none"
                        onclick="bulkDelete()"><i class="fas fa-trash"></i> Delete Selected</button>
                    <button class="btn btn-sm btn-outline-warning" id="bulk-edit-btn" style="display:none"
                        onclick="showBulkEditModal()"><i class="fas fa-edit"></i> Bulk Edit</button>
                </div>
            </div>
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <div class="col"><input type="text" class="form-control form-control-sm" id="filter-search"
                            placeholder="Search..."></div>
                    <div class="col"><select class="form-select form-select-sm" id="filter-category">
                            <option value="">All Categories</option>
                        </select></div>
                    <div class="col"><select class="form-select form-select-sm" id="filter-cardholder">
                            <option value="">All Cardholders</option>
                        </select></div>
                    <div class="col"><select class="form-select form-select-sm" id="filter-type">
                            <option value="">All Types</option>
                            <option value="debit">Debit</option>
                            <option value="credit">Credit</option>
                            <option value="deposit">Deposit</option>
                            <option value="fee">Fee</option>
                            <option value="payment">Payment</option>
                        </select></div>
                    <div class="col"><input type="date" class="form-control form-control-sm" id="filter-date-from">
                    </div>
                    <div class="col"><input type="date" class="form-control form-control-sm" id="filter-date-to"></div>
                    <div class="col"><select class="form-select form-select-sm" id="filter-flags">
                            <option value="">All</option>
                            <option value="flagged">Flagged</option>
                            <option value="personal">Personal</option>
                            <option value="business">Business</option>
                            <option value="transfer">Transfers</option>
                        </select></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" id="filter-min-amt"
                            placeholder="Min $"></div>
                    <div class="col-auto"><button class="btn btn-sm btn-info" onclick="readFilterUI()"><i
                                class="fas fa-filter"></i> Filter</button></div>
                    <div class="col-auto"><button class="btn btn-sm btn-outline-light" onclick="clearFilters()"><i
                                class="fas fa-times"></i></button></div>
                    <div class="col-auto"><button class="btn btn-sm btn-outline-light" onclick="saveCurrentFilter()"
                            title="Save this filter"><i class="fas fa-bookmark"></i></button></div>
                </div>
                <div id="saved-filters-bar" class="mt-2" style="display:none;"></div>
            </div>
            <div class="card-dark">
                <div class="scrollable-table">
                    <table class="table table-dark-custom">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Cardholder</th>
                                <th>Card</th>
                                <th>Method</th>
                                <th>Tags</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center p-2"
                    style="border-top:1px solid #30363d;">
                    <span id="trans-count" class="text-muted small"></span>
                    <div class="pagination-controls" id="pagination-controls" style="display:none;">
                        <button class="btn btn-sm btn-outline-light" onclick="goToPage(1)" id="page-first"><i
                                class="fas fa-angle-double-left"></i></button>
                        <button class="btn btn-sm btn-outline-light" onclick="goToPage(currentPage-1)" id="page-prev"><i
                                class="fas fa-angle-left"></i></button>
                        <span class="text-muted small mx-2" id="page-info"></span>
                        <button class="btn btn-sm btn-outline-light" onclick="goToPage(currentPage+1)" id="page-next"><i
                                class="fas fa-angle-right"></i></button>
                        <button class="btn btn-sm btn-outline-light" onclick="goToPage(totalPages)" id="page-last"><i
                                class="fas fa-angle-double-right"></i></button>
                        <select class="form-select form-select-sm d-inline-block ms-2"
                            style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;"
                            id="per-page-select" onchange="changePerPage(this.value)">
                            <option value="50">50/page</option>
                            <option value="100" selected>100/page</option>
                            <option value="250">250/page</option>
                            <option value="0">Show All</option>
                        </select>
                    </div>
                    <span id="trans-total" class="text-muted small fw-bold"></span>
                </div>
            </div>
        </div>

        <!-- ========== FORENSIC ANALYSIS ========== -->
        <div class="page-section" id="page-analysis">
            <h4 class="mb-1"><i class="fas fa-magnifying-glass-chart text-danger"></i> Forensic Analysis</h4>
            <p class="text-muted small mb-3">Tracking money flow: deposits, transfers, and suspicious patterns</p>

            <div class="card-dark mb-3">
                <div class="card-header" style="background:rgba(248,81,73,0.1);">
                    <span><i class="fas fa-exchange-alt text-danger me-1"></i> Deposit-to-Transfer Tracking</span>
                    <small class="text-muted">Deposits followed by outbound transfers within 7 days</small>
                </div>
                <div class="scrollable-table" id="deposit-transfer-analysis"></div>
            </div>

            <div class="card-dark mb-3">
                <div class="card-header"><i class="fas fa-flag text-danger me-1"></i> All Flagged Transactions</div>
                <div class="scrollable-table" id="flagged-transactions"></div>
            </div>

            <div class="card-dark mb-3">
                <div class="card-header"><i class="fas fa-hand-holding-usd text-warning me-1"></i> Venmo Payment
                    Analysis</div>
                <div class="scrollable-table" id="venmo-analysis"></div>
            </div>
        </div>

        <!-- ========== CARDHOLDERS ========== -->
        <div class="page-section" id="page-cardholders">
            <h4 class="mb-1"><i class="fas fa-users text-info"></i> Cardholder Breakdown</h4>
            <p class="text-muted small mb-3">Click any cardholder to see their full transaction history</p>
            <div id="cardholders-content"></div>
        </div>

        <!-- ========== ACCOUNTS ========== -->
        <div class="page-section" id="page-accounts">
            <h4 class="mb-1"><i class="fas fa-university text-info"></i> Accounts Overview</h4>
            <p class="text-muted small mb-3">All linked accounts and their transaction summaries</p>
            <div id="accounts-content"></div>
        </div>

        <!-- ========== UPLOAD ========== -->
        <div class="page-section" id="page-upload">
            <h4 class="mb-3"><i class="fas fa-cloud-upload-alt text-info"></i> Upload Documents</h4>
            <div class="row g-4">
                <div class="col-md-8">
                    <div class="upload-zone" id="upload-zone">
                        <i class="fas fa-file-pdf upload-icon"></i>
                        <h5>Drop files here or click to browse</h5>
                        <p class="text-muted small">PDF, Excel (.xlsx), CSV, Word (.docx), ZIP (.zip) - up to 50MB</p>
                        <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.csv,.docx,.zip"
                            style="display:none">
                    </div>
                    <div id="upload-status" class="mt-3"></div>
                    <div id="upload-preview" style="display:none;"></div>
                    <div id="upload-results" class="mt-3"></div>
                </div>
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header">Upload Settings</div>
                        <div class="card-body">
                            <div class="mb-3"><label class="form-label small">Document Type</label>
                                <select class="form-select form-select-sm" id="upload-doc-type">
                                    <option value="auto">Auto-Detect</option>
                                    <option value="bank_statement">Bank Statement</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="venmo">Venmo</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                    <option value="proof">Proof Document</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label small">Category</label>
                                <select class="form-select form-select-sm" id="upload-doc-category">
                                    <option value="bank_statement">Bank Statement</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="venmo">Venmo</option>
                                    <option value="proof">Proof/Evidence</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="alert alert-info small py-2"><i class="fas fa-info-circle"></i> Files are
                                previewed before import. Review and edit categories, then commit.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== DOCUMENTS ========== -->
        <div class="page-section" id="page-documents">
            <h4 class="mb-3"><i class="fas fa-folder-open text-info"></i> Uploaded Documents</h4>
            <div class="card-dark">
                <div class="scrollable-table">
                    <table class="table table-dark-custom">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Account</th>
                                <th>Status</th>
                                <th>Parsed</th>
                                <th>Imported</th>
                                <th>Skipped</th>
                                <th>Uploaded</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documents-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== CATEGORIES/RULES ========== -->
        <div class="page-section" id="page-categories">
            <h4 class="mb-3"><i class="fas fa-tags text-info"></i> Categories, Rules & Taxonomy</h4>

            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card-dark">
                        <div class="card-header">
                            <span><i class="fas fa-list-ul text-warning me-1"></i> Taxonomy Configuration</span>
                            <button class="btn btn-sm btn-info" onclick="showAddTaxonomyModal()"><i
                                    class="fas fa-plus"></i> Add Taxonomy</button>
                        </div>
                        <div class="scrollable-table" id="taxonomy-list"></div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card-dark">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Categories</span>
                            <button class="btn btn-sm btn-outline-warning" onclick="restoreCategoriesDefaults()"><i
                                    class="fas fa-undo"></i> Restore Defaults</button>
                        </div>
                        <div class="scrollable-table" id="categories-list"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-dark">
                        <div class="card-header"><span>Auto-Categorization Rules</span><button
                                class="btn btn-sm btn-info" onclick="showAddRuleModal()"><i class="fas fa-plus"></i>
                                Add</button></div>
                        <div class="scrollable-table" id="rules-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Taxonomy Modal -->
        <div class="modal fade" id="addTaxonomyModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title"><i class="fas fa-plus"></i> Add Taxonomy Rule</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label class="form-label small">Name / Term</label>
                            <input type="text" class="form-control form-control-sm" id="tax-name"
                                placeholder="e.g. Fraud Risk">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Description</label>
                            <input type="text" class="form-control form-control-sm" id="tax-desc"
                                placeholder="Indicators of fraud">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Category Type</label>
                            <input type="text" class="form-control form-control-sm" id="tax-category-type"
                                placeholder="e.g. risk, entity, topic">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Severity</label>
                            <select class="form-select form-select-sm" id="tax-severity">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-sm btn-info" onclick="addTaxonomy()">Save Taxonomy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== RECIPIENTS (Who Gets The Money) ========== -->
        <div class="page-section" id="page-recipients">
            <h4 class="mb-1"><i class="fas fa-user-secret text-danger"></i> Who Gets The Money</h4>
            <p class="text-muted small mb-3">Recipient profiling with suspicion scoring - identifies who receives
                outflows and flags suspicious patterns</p>
            <div id="recipients-summary" class="row g-3 mb-3"></div>
            <div class="card-dark">
                <div class="card-header" style="background:rgba(248,81,73,0.1);">
                    <span><i class="fas fa-crosshairs text-danger me-1"></i> All Recipients</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block"
                            style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;"
                            id="recipient-sort" onchange="renderRecipients()">
                            <option value="total">Sort by Total</option>
                            <option value="suspicion">Sort by Suspicion</option>
                            <option value="count">Sort by Frequency</option>
                            <option value="name">Sort by Name</option>
                        </select>
                    </div>
                </div>
                <div class="scrollable-table" style="max-height:70vh;" id="recipients-table"></div>
            </div>
        </div>

        <!-- ========== DEPOSIT AGING ========== -->
        <div class="page-section" id="page-deposit-aging">
            <h4 class="mb-1"><i class="fas fa-clock text-warning"></i> Deposit Aging Analysis</h4>
            <p class="text-muted small mb-3">How quickly do deposits leave the account? Fast outflows after deposits
                suggest money diversion.</p>
            <div id="aging-summary" class="row g-3 mb-3"></div>
            <div class="card-dark">
                <div class="card-header" style="background:rgba(210,153,34,0.1);">
                    <span><i class="fas fa-hourglass-half text-warning me-1"></i> Deposit Drain Timeline</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block"
                            style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;" id="aging-filter"
                            onchange="renderDepositAging()">
                            <option value="all">All Deposits</option>
                            <option value="high">High Risk Only</option>
                            <option value="medium">Medium+ Risk</option>
                        </select>
                    </div>
                </div>
                <div class="scrollable-table" style="max-height:70vh;" id="aging-table"></div>
            </div>
        </div>

        <!-- ========== MONEY FLOW ========== -->
        <div class="page-section" id="page-money-flow">
            <h4 class="mb-1"><i class="fas fa-project-diagram text-info"></i> Money Flow</h4>
            <p class="text-muted small mb-3">Track how money moves between accounts and payment channels</p>
            <div id="money-flow-summary" class="row g-3 mb-3"></div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-university me-1"></i> Account Flows</div>
                        <div class="scrollable-table" id="flow-accounts"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-exchange-alt me-1"></i> Transfer Destinations</div>
                        <div class="scrollable-table" id="flow-transfers"></div>
                    </div>
                </div>
            </div>
            <div class="card-dark">
                <div class="card-header"><i class="fas fa-credit-card me-1"></i> Payment Method Breakdown</div>
                <div class="scrollable-table" id="flow-methods"></div>
            </div>
        </div>

        <!-- ========== TIMELINE ========== -->
        <div class="page-section" id="page-timeline">
            <h4 class="mb-1"><i class="fas fa-chart-line text-info"></i> Transaction Timeline</h4>
            <p class="text-muted small mb-3">Daily money movement over time - green bars = deposits, red bars =
                spending, yellow = transfers</p>
            <div id="timeline-summary" class="row g-3 mb-3"></div>
            <div class="card-dark">
                <div class="card-header">
                    <span><i class="fas fa-calendar-alt me-1"></i> Daily Activity</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block"
                            style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;"
                            id="timeline-scale" onchange="renderTimeline()">
                            <option value="auto">Auto Scale</option>
                            <option value="fixed">Fixed Scale</option>
                        </select>
                    </div>
                </div>
                <div class="p-3" id="timeline-chart" style="max-height:70vh;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- ========== RECURRING TRANSACTIONS ========== -->
        <div class="page-section" id="page-recurring">
            <h4 class="mb-1"><i class="fas fa-redo text-warning"></i> Recurring Transactions</h4>
            <p class="text-muted small mb-3">Detect payments that occur at regular intervals - subscriptions, recurring
                charges, and potential unauthorized automatic payments</p>
            <div id="recurring-summary" class="row g-3 mb-3"></div>
            <div class="card-dark">
                <div class="card-header">
                    <span><i class="fas fa-sync-alt me-1"></i> Detected Patterns</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block"
                            style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;"
                            id="recurring-filter" onchange="renderRecurring()">
                            <option value="all">All Frequencies</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Biweekly">Biweekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="scrollable-table" style="max-height:70vh;" id="recurring-table"></div>
            </div>
        </div>

        <!-- ========== CARDHOLDER TIMELINE ========== -->
        <div class="page-section" id="page-cardholder-timeline">
            <h4 class="mb-1"><i class="fas fa-chart-area text-info"></i> Cardholder Timeline Comparison</h4>
            <p class="text-muted small mb-3">Overlay spending patterns to compare cardholder activity over time and spot
                correlation patterns</p>
            <div class="card-dark mb-3">
                <div class="card-header"><i class="fas fa-users me-1"></i> Monthly Spending Overlay</div>
                <div class="p-2">
                    <div class="chart-container" style="height:350px;"><canvas id="cardholder-timeline-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-chart-bar me-1"></i> Personal vs Business by
                            Cardholder</div>
                        <div class="p-2">
                            <div class="chart-container"><canvas id="personal-business-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-dark">
                        <div class="card-header"><i class="fas fa-table me-1"></i> Monthly Detail</div>
                        <div class="scrollable-table" style="max-height:350px;" id="cardholder-timeline-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== ALERTS ========== -->
        <div class="page-section" id="page-alerts">
            <h4 class="mb-1"><i class="fas fa-bell text-warning"></i> Alerts</h4>
            <p class="text-muted small mb-3">Items needing your attention - click any alert to jump to the relevant
                transactions</p>
            <div id="alerts-summary" class="row g-3 mb-3"></div>
            <div class="card-dark">
                <div class="card-header"><i class="fas fa-exclamation-circle me-1"></i> Active Alerts</div>
                <div id="alerts-list" class="p-0"></div>
            </div>
        </div>

        <!-- ========== CASE NOTES ========== -->
        <div class="page-section" id="page-case-notes">
            <h4 class="mb-1"><i class="fas fa-sticky-note text-info"></i> Case Notes</h4>
            <p class="text-muted small mb-3">Investigation journal - document findings, evidence, and timeline
                observations</p>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <select class="form-select form-select-sm d-inline-block"
                        style="width:auto;background:#0d1117;border-color:#30363d;color:#c9d1d9;" id="note-filter"
                        onchange="renderCaseNotes()">
                        <option value="all">All Notes</option>
                        <option value="finding">Findings</option>
                        <option value="evidence">Evidence</option>
                        <option value="timeline">Timeline</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <button class="btn btn-sm btn-info" onclick="showAddNoteModal()"><i class="fas fa-plus me-1"></i>Add
                    Note</button>
            </div>
            <div id="case-notes-list"></div>
        </div>

        <!-- Case Note Modal -->
        <div class="modal fade" id="noteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="noteModalTitle"><i class="fas fa-sticky-note"></i> Add Note</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2"><label class="form-label small">Title</label><input type="text"
                                class="form-control form-control-sm" id="note-title"></div>
                        <div class="mb-2"><label class="form-label small">Content</label><textarea
                                class="form-control form-control-sm" id="note-content" rows="5"></textarea></div>
                        <div class="row g-2">
                            <div class="col-6"><label class="form-label small">Type</label>
                                <select class="form-select form-select-sm" id="note-type">
                                    <option value="general">General</option>
                                    <option value="finding">Finding</option>
                                    <option value="evidence">Evidence</option>
                                    <option value="timeline">Timeline</option>
                                </select>
                            </div>
                            <div class="col-6"><label class="form-label small">Severity</label>
                                <select class="form-select form-select-sm" id="note-severity">
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="danger">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                            data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-info"
                            id="note-save-btn" onclick="saveNote()">Save</button></div>
                </div>
            </div>
        </div>

        <!-- ========== AUDIT TRAIL ========== -->
        <div class="page-section" id="page-audit-trail">
            <h4 class="mb-1"><i class="fas fa-history text-info"></i> Audit Trail</h4>
            <p class="text-muted small mb-3">Complete log of all edits, deletions, and changes made to transactions</p>
            <div class="card-dark">
                <div class="card-header">
                    <span><i class="fas fa-clipboard-list me-1"></i> Recent Changes</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadAuditTrail()"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
                <div class="scrollable-table" style="max-height:75vh;" id="audit-trail-table"></div>
            </div>
        </div>

        <!-- ========== SETTINGS ========== -->
        {% if enable_integrations %}
        <div class="page-section" id="page-settings">
            <h4 class="mb-1"><i class="fas fa-cog text-info"></i> Settings & Administration</h4>
            <ul class="nav nav-tabs mb-3" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="navigateTo('settings')"
                        style="background: transparent; color: #58a6ff; border: none; border-bottom: 2px solid #58a6ff;">General</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="navigateTo('integrations')"
                        style="color: #c9d1d9; border: none;">Integrations</a>
                </li>
            </ul>
            <div class="card-dark p-4 text-center position-relative">
                <p class="text-muted">General settings panel. Ensure the Integrations route is navigated.</p>
                <button class="btn btn-outline-info" onclick="navigateTo('integrations')">View Integrations</button>

                <!-- User Badge -->
                <div class="position-absolute bottom-0 end-0 p-3">
                    <div class="d-flex align-items-center rounded px-3 py-2 shadow-sm"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                        <span class="text-muted me-3 small"><i class="fas fa-user-check text-success me-2"></i>{{
                            current_user.email }}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="logout()" title="Sign Out">
                            <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== INTEGRATIONS ========== -->
        <div class="page-section position-relative" id="page-integrations" style="min-height: 400px;">
            <h4 class="mb-1"><i class="fas fa-plug text-primary"></i> Data Integrations</h4>
            <ul class="nav nav-tabs mb-3" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="navigateTo('settings')"
                        style="color: #c9d1d9; border: none;">General</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="navigateTo('integrations')"
                        style="background: transparent; color: #58a6ff; border: none; border-bottom: 2px solid #58a6ff;">Integrations</a>
                </li>
            </ul>
            <p class="text-muted small mb-3">Connect external providers to automate forensics workflows</p>

            <div class="row g-3" id="integrations-list">
                <!-- Managed by JS loadIntegrations() -->
            </div>

            <!-- User Badge -->
            <div class="position-absolute bottom-0 end-0 p-3">
                <div class="d-flex align-items-center rounded px-3 py-2 shadow-sm"
                    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <span class="text-muted me-3 small"><i class="fas fa-user-check text-success me-2"></i>{{
                        current_user.email }}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()" title="Sign Out">
                        <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="fas fa-edit"></i> Edit Transaction</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="edit-form-body"></div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                        data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-info"
                        onclick="saveTransaction()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal fade" id="addTransModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="fas fa-plus"></i> Add Transaction</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label small">Date</label><input type="date"
                            class="form-control form-control-sm" id="add-date"></div>
                    <div class="mb-2"><label class="form-label small">Description</label><input type="text"
                            class="form-control form-control-sm" id="add-desc"></div>
                    <div class="mb-2"><label class="form-label small">Amount (negative=debit)</label><input
                            type="number" step="0.01" class="form-control form-control-sm" id="add-amount"></div>
                    <div class="mb-2"><label class="form-label small">Category</label><select
                            class="form-select form-select-sm" id="add-category"></select></div>
                    <div class="mb-2"><label class="form-label small">Cardholder</label><input type="text"
                            class="form-control form-control-sm" id="add-cardholder"></div>
                    <div class="mb-2"><label class="form-label small">Card Last 4</label><input type="text"
                            class="form-control form-control-sm" id="add-card" maxlength="4"></div>
                    <div class="mb-2"><label class="form-label small">Method</label><select
                            class="form-select form-select-sm" id="add-method">
                            <option value="">--</option>
                            <option>debit</option>
                            <option>credit</option>
                            <option>check</option>
                            <option>venmo</option>
                            <option>transfer</option>
                            <option>wire</option>
                            <option>cash</option>
                        </select></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="add-personal"><label class="form-check-label small">Personal</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="add-business"><label class="form-check-label small">Business</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="add-transfer"><label class="form-check-label small">Transfer</label></div>
                </div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                        data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-info"
                        onclick="addManualTransaction()">Add</button></div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal fade" id="bulkEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="fas fa-edit"></i> Bulk Edit <span id="bulk-count"></span></h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label small">Category</label><select
                            class="form-select form-select-sm" id="bulk-category">
                            <option value="">-- No Change --</option>
                        </select></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="bulk-personal"><label class="form-check-label small">Personal</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="bulk-business"><label class="form-check-label small">Business</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="bulk-transfer"><label class="form-check-label small">Transfer</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="bulk-flagged"><label class="form-check-label small">Flagged</label></div>
                    <div class="mt-2"><label class="form-label small">Notes</label><input type="text"
                            class="form-control form-control-sm" id="bulk-notes"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                        data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-warning"
                        onclick="saveBulkEdit()">Apply</button></div>
            </div>
        </div>
    </div>

    <!-- Add Rule Modal -->
    <div class="modal fade" id="addRuleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="fas fa-plus"></i> Add Rule</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label small">Pattern (% = wildcard)</label><input type="text"
                            class="form-control form-control-sm" id="rule-pattern" placeholder="%WALMART%"></div>
                    <div class="mb-2"><label class="form-label small">Category</label><select
                            class="form-select form-select-sm" id="rule-category"></select></div>
                    <div class="mb-2"><label class="form-label small">Priority</label><input type="number"
                            class="form-control form-control-sm" id="rule-priority" value="50"></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="rule-personal"><label class="form-check-label small">Personal</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="rule-business"><label class="form-check-label small">Business</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input"
                            id="rule-transfer-flag"><label class="form-check-label small">Transfer</label></div>
                </div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                        data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-info"
                        onclick="addRule()">Add</button></div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="fas fa-plus"></i> Add Category</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label small">Name</label><input type="text"
                            class="form-control form-control-sm" id="new-cat-name" placeholder="e.g. Travel"></div>
                    <div class="mb-2"><label class="form-label small">Parent Category (Optional)</label><input
                            type="text" class="form-control form-control-sm" id="new-cat-parent"
                            placeholder="e.g. Business"></div>
                    <div class="mb-2"><label class="form-label small">Type</label><select
                            class="form-select form-select-sm" id="new-cat-type">
                            <option value="other">Other</option>
                            <option value="business">Business</option>
                            <option value="personal">Personal</option>
                            <option value="transfer">Transfer</option>
                            <option value="fee">Fee</option>
                        </select></div>
                    <div class="mb-2"><label class="form-label small">Color</label><input type="color"
                            class="form-control form-control-sm form-control-color" id="new-cat-color" value="#6c757d">
                    </div>
                    <div class="mb-2"><label class="form-label small">Icon (FontAwesome Name)</label><input type="text"
                            class="form-control form-control-sm" id="new-cat-icon" placeholder="tag" value="tag"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-sm btn-secondary"
                        data-bs-dismiss="modal">Cancel</button><button class="btn btn-sm btn-info"
                        onclick="saveCategory()">Add</button></div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/shared/types/index.js"></script>
    <script src="/shared/url.js"></script>
    <script src="/shared/store.js"></script>
    <script src="/shared/drilldown.js"></script>
    <script>
        // =====
        const initialFilters = hydrateFilters(window.location.search);
        if (!initialFilters.view_mode) {
            initialFilters.view_mode = sessionStorage.getItem('viewMode') || 'all';
        }
        window.FilterStore = new GlobalFilterStore(initialFilters);
        window.GlobalBreadcrumbs = new BreadcrumbStore();

        // ===== NAVIGATION HISTORY STATE =====
        window.NavigationHistory = [];
        let isNavigatingBack = false;

        function pushHistoryState(page, filters) {
            if (isNavigatingBack) {
                isNavigatingBack = false;
                return;
            }

            // Only push if different from current top
            const top = window.NavigationHistory[window.NavigationHistory.length - 1];
            if (!top || top.page !== page || JSON.stringify(top.filters) !== JSON.stringify(filters)) {
                window.NavigationHistory.push({ page, filters: JSON.parse(JSON.stringify(filters)) });
            }
            updateBackButton();
        }

        function popHistoryState() {
            if (window.NavigationHistory.length > 1) {
                window.NavigationHistory.pop(); // Remove current
                const prevState = window.NavigationHistory[window.NavigationHistory.length - 1];
                updateBackButton();
                return prevState;
            }
            return null;
        }

        function updateBackButton() {
            const btn = document.getElementById('global-back-btn');
            if (btn) {
                const top = window.NavigationHistory.length > 0 ? window.NavigationHistory[window.NavigationHistory.length - 1] : null;
                const onDashboard = top && top.page === 'dashboard';

                // Show if history > 1 OR we are deep-linked into a detail page
                if (window.NavigationHistory.length > 1 || !onDashboard) {
                    btn.classList.remove('d-none');
                } else {
                    btn.classList.add('d-none');
                }
            }
        }

        function goBack() {
            if (window.NavigationHistory.length > 1) {
                const prevState = popHistoryState();
                if (prevState) {
                    isNavigatingBack = true;
                    window.FilterStore.replace(prevState.filters);
                    navigateTo(prevState.page, true, false);
                }
            } else if (window.history.length > 1 && document.referrer.includes(window.location.host)) {
                // Native browser back if it's within our app domain limits spanning tabs
                window.history.back();
            } else {
                // Fallback safe route (Dashboard) for deep links
                window.FilterStore.clear();
                navigateTo('dashboard', true, true);
            }
        }

        // Subscribe to FilterStore to update URL and UI automatically
        window.FilterStore.subscribe((filters) => {
            const qs = serializeFilters(filters);
            const activePage = document.querySelector('.nav-link.active')?.dataset.page || 'dashboard';
            const newUrl = qs ? `/?${qs}` : '/';
            window.history.replaceState({ filters, page: activePage }, '', newUrl);

            // Record standard filter changes to internal stack if not navigating back
            pushHistoryState(activePage, filters);

            // Sync the UI top bar inputs
            if (typeof syncFilterUI === 'function') syncFilterUI(filters);

            // Persist view_mode to session and update toggle bar
            if (filters.view_mode) {
                sessionStorage.setItem('viewMode', filters.view_mode);
                document.querySelectorAll('.view-toggle-bar .toggle-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.mode === filters.view_mode);
                });
            }

            // Sync Date Presets UI
            if (filters.date_preset) {
                document.querySelectorAll('.date-picks .btn').forEach(b => {
                    b.classList.toggle('btn-info', b.dataset.preset === filters.date_preset);
                    b.classList.toggle('btn-outline-light', b.dataset.preset !== filters.date_preset);
                });
            } else {
                document.querySelectorAll('.date-picks .btn').forEach(b => {
                    b.classList.remove('btn-info');
                    b.classList.add('btn-outline-light');
                });
            }

            // Reload the active tab's data using the new filters
            loadPageData(activePage, filters);
        });

        // Handle browser Back/Forward navigation
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.filters) {
                window.FilterStore.replace(e.state.filters);
                if (e.state.page) {
                    navigateTo(e.state.page, false); // Don't trigger another data load, the replace() via subscription will
                }
            } else {
                const restored = hydrateFilters(window.location.search);
                window.FilterStore.replace(restored);
            }
        });

        let allTransactions = [];
        let allCategories = [];
        let selectedIds = new Set();
        let editingId = null;
        let dashStats = null;
        let currentPreviewId = null;
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 100;
        let recurringData = [];
        let cardholderTimelineChart = null;
        let personalBusinessChart = null;

        // ===== BREADCRUMBS =====
        window.GlobalBreadcrumbs.subscribe(renderBreadcrumbs);

        function renderBreadcrumbs(history) {
            const container = document.getElementById('global-breadcrumbs');
            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            let html = '<div class="breadcrumb-bar">';

            history.forEach((crumb, idx) => {
                html += `<span class="crumb" onclick="restoreBreadcrumb(${idx})">${esc(crumb.label)}</span><span class="separator">/</span>`;
            });

            // Current view generic label
            html += '<span class="current-view">Detail View</span></div>';
            container.innerHTML = html;
        }

        function restoreBreadcrumb(idx) {
            const snapshot = window.GlobalBreadcrumbs.pop(idx);
            if (snapshot) {
                FilterStore.replace(snapshot.filters);
                navigateTo(snapshot.target);
            }
        }

        async function logDrilldownEvent(record) {
            try {
                await fetch('/api/drilldowns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
            } catch (e) { console.error('Drilldown log failed', e); }
        }

        // ===== VIEW MODE TOGGLE =====
        function setViewMode(mode) {
            FilterStore.update({ view_mode: mode });
        }

        function clearFilters() {
            FilterStore.clear();
            syncFilterUI();
            loadTransactions();
        }

        function setDateRange(preset) {
            const updates = { date_preset: preset, date_from: null, date_to: null };
            const today = new Date();
            if (preset === '30') {
                const d = new Date(); d.setDate(d.getDate() - 30);
                updates.date_from = d.toISOString().split('T')[0];
            } else if (preset === '90') {
                const d = new Date(); d.setDate(d.getDate() - 90);
                updates.date_from = d.toISOString().split('T')[0];
            } else if (preset === 'ytd') {
                updates.date_from = `${today.getFullYear()}-01-01`;
            } else if (preset === '2024') {
                updates.date_from = '2024-01-01'; updates.date_to = '2024-12-31';
            } else if (preset === '2023') {
                updates.date_from = '2023-01-01'; updates.date_to = '2023-12-31';
            }
            FilterStore.update(updates);
        }

        function syncFilterUI(filters) {
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
            filters = filters || FilterStore.getState();
            setVal('filter-search', filters.search);
            setVal('filter-category', filters.category);
            setVal('filter-cardholder', filters.cardholder);
            setVal('filter-type', filters.trans_type);
            setVal('filter-date-from', filters.date_from);
            setVal('filter-date-to', filters.date_to);
            setVal('filter-min-amt', filters.min_amount);

            const elFlags = document.getElementById('filter-flags');
            if (elFlags) {
                if (filters.is_flagged) elFlags.value = 'flagged';
                else if (filters.is_personal) elFlags.value = 'personal';
                else if (filters.is_business) elFlags.value = 'business';
                else if (filters.is_transfer) elFlags.value = 'transfer';
                else elFlags.value = '';
            }
        }

        function readFilterUI() {
            const getVal = (id) => { const el = document.getElementById(id); return el && el.value ? el.value : null; };
            const updates = {
                search: getVal('filter-search'),
                category: getVal('filter-category'),
                cardholder: getVal('filter-cardholder'),
                trans_type: getVal('filter-type'),
                date_from: getVal('filter-date-from'),
                date_to: getVal('filter-date-to'),
                min_amount: getVal('filter-min-amt'),
                date_preset: 'custom',
                is_flagged: null,
                is_personal: null,
                is_business: null,
                is_transfer: null
            };

            const fl = getVal('filter-flags');
            if (fl === 'flagged') updates.is_flagged = '1';
            if (fl === 'personal') updates.is_personal = '1';
            if (fl === 'business') updates.is_business = '1';
            if (fl === 'transfer') updates.is_transfer = '1';

            FilterStore.update(updates);
        }

        // ===== NAVIGATION =====
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                if (window.GlobalBreadcrumbs) window.GlobalBreadcrumbs.clear();
                navigateTo(link.dataset.page, true);
            });
        });

        function navigateTo(page, triggerLoad = true, recordHistory = true) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`.nav-link[data-page="${page}"]`);
            if (link) link.classList.add('active');

            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            const section = document.getElementById('page-' + page);
            if (section) section.classList.add('active');

            if (triggerLoad) {
                const state = window.FilterStore.getState();
                loadPageData(page, state);

                if (recordHistory) {
                    pushHistoryState(page, state);
                }

                // Also update the URL with the new page state (conceptually, tabs are just hash or state, we use replaceState)
                window.history.replaceState({ filters: state, page }, '', window.location.search || '/');
            }
        }

        function loadPageData(page, filters) {
            if (!filters) filters = window.FilterStore.getState();
            if (page === 'dashboard') loadDashboard(filters);
            else if (page === 'transactions') loadTransactions(filters);
            else if (page === 'analysis') loadAnalysis(filters);
            else if (page === 'recipients') loadRecipients(filters);
            else if (page === 'deposit-aging') loadDepositAging(filters);
            else if (page === 'cardholders') loadCardholders(filters);
            else if (page === 'money-flow') loadMoneyFlow(filters);
            else if (page === 'timeline') loadTimeline(filters);
            else if (page === 'recurring') loadRecurring(filters);
            else if (page === 'cardholder-timeline') loadCardholderTimeline(filters);
            else if (page === 'alerts') loadAlerts(filters);
            else if (page === 'case-notes') loadCaseNotes();
            else if (page === 'accounts') loadAccounts();
            else if (page === 'documents') loadDocuments();
            else if (page === 'categories') loadCategoriesPage();
            else if (page === 'audit-trail') loadAuditTrail();
            else if (page === 'integrations') loadIntegrations();

            // Close sidebar on mobile after navigation
            if (window.innerWidth <= 768) toggleSidebar(false);
        }

        // ===== DRILL-DOWN: Navigate to transactions with pre-set filters =====
        function drillToTransactions(filterObj) {
            const sourceTab = document.querySelector('.nav-link.active')?.dataset.page || 'unknown';
            const label = sourceTab.charAt(0).toUpperCase() + sourceTab.slice(1).replace('-', ' ');

            const handler = window.createDrilldownHandler({
                sourceTab: sourceTab,
                widgetId: 'table-row-drilldown',
                defaultTarget: DrilldownTarget.TRANSACTIONS,
                breadcrumbLabel: label,
                breadcrumbStore: window.GlobalBreadcrumbs,
                getState: () => FilterStore.getState(),
                onLogEvent: logDrilldownEvent,
                onNavigate: (target, nextFilters) => {
                    // Update DOM navigation first to avoid double-fetching during replace
                    navigateTo(target.toLowerCase(), false);
                    FilterStore.replace(nextFilters);
                }
            });

            handler({ filters: filterObj });
        }

        // ===== DASHBOARD =====
        // ===== DATE RANGE QUICK PICKS =====

        function setDateRange(range) {
            const updates = {
                date_preset: range,
                date_from: null,
                date_to: null
            };

            const now = new Date();
            if (range === '30') {
                const d = new Date(now); d.setDate(d.getDate() - 30);
                updates.date_from = d.toISOString().slice(0, 10);
            } else if (range === '90') {
                const d = new Date(now); d.setDate(d.getDate() - 90);
                updates.date_from = d.toISOString().slice(0, 10);
            } else if (range === 'ytd') {
                updates.date_from = now.getFullYear() + '-01-01';
            } else if (range === '2024') {
                updates.date_from = '2024-01-01'; updates.date_to = '2024-12-31';
            } else if (range === '2023') {
                updates.date_from = '2023-01-01'; updates.date_to = '2023-12-31';
            }

            document.querySelectorAll('.date-picks .btn').forEach(b => b.classList.remove('btn-info'));
            if (event && event.target) {
                event.target.classList.add('btn-info');
                event.target.classList.remove('btn-outline-light');
            }

            FilterStore.update(updates);
            // Re-load will be triggered automatically by subscription
        }

        async function loadDashboard(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            dashStats = await api('/api/stats?' + qs);
            const s = dashStats;
            const net = s.total_deposits - s.total_withdrawals;

            // Load executive summary
            loadExecutiveSummary();

            document.getElementById('stats-cards').innerHTML = `
            <div class="col"><div class="stat-card success" onclick="drillToTransactions({trans_type:'deposit'})"><div class="stat-value">$${fmt(s.total_deposits)}</div><div class="stat-label"><i class="fas fa-arrow-down"></i> Deposits (${s.deposit_count})</div></div></div>
            <div class="col"><div class="stat-card danger" onclick="drillToTransactions({})"><div class="stat-value">$${fmt(s.total_withdrawals)}</div><div class="stat-label"><i class="fas fa-arrow-up"></i> Withdrawals (${s.withdrawal_count})</div></div></div>
            <div class="col"><div class="stat-card danger" onclick="drillToTransactions({is_transfer:'1'})"><div class="stat-value">$${fmt(s.transfers_out)}</div><div class="stat-label"><i class="fas fa-exchange-alt"></i> Transfers Out (${s.transfer_out_count})</div></div></div>
            <div class="col"><div class="stat-card warning" onclick="drillToTransactions({is_personal:'1'})"><div class="stat-value">$${fmt(s.personal_total)}</div><div class="stat-label"><i class="fas fa-user"></i> Personal (${s.personal_count})</div></div></div>
            <div class="col"><div class="stat-card info" onclick="drillToTransactions({is_business:'1'})"><div class="stat-value">$${fmt(s.business_total)}</div><div class="stat-label"><i class="fas fa-briefcase"></i> Business (${s.business_count})</div></div></div>
            <div class="col"><div class="stat-card ${s.flagged_count > 0 ? 'danger' : ''}" onclick="drillToTransactions({is_flagged:'1'})"><div class="stat-value">${s.flagged_count}</div><div class="stat-label"><i class="fas fa-flag"></i> Flagged</div></div></div>
            <div class="col"><div class="stat-card ${net < 0 ? 'danger' : 'success'}"><div class="stat-value">$${fmt(Math.abs(net))}</div><div class="stat-label"><i class="fas fa-${net < 0 ? 'arrow-trend-down' : 'arrow-trend-up'}"></i> Net ${net < 0 ? 'Outflow' : 'Inflow'}</div></div></div>
        `;

            // Cardholder table (clickable)
            let chHtml = '<table class="table table-dark-custom"><thead><tr><th>Cardholder</th><th>Spent</th><th>Count</th><th>Bar</th></tr></thead><tbody>';
            const maxSpent = Math.max(...(s.by_cardholder || []).map(c => c.total_spent), 1);
            (s.by_cardholder || []).forEach(ch => {
                const pct = (ch.total_spent / maxSpent * 100).toFixed(0);
                chHtml += `<tr class="clickable-row" onclick="drillToTransactions({cardholder:'${esc(ch.cardholder_name)}'})" title="Click to see all transactions">
                <td>${esc(ch.cardholder_name || 'Unknown')}</td>
                <td class="amount-negative">$${fmt(ch.total_spent)}</td>
                <td>${ch.cnt}</td>
                <td><div class="mini-bar" style="background:#f85149;width:${pct}%;">&nbsp;</div></td>
            </tr>`;
            });
            chHtml += '</tbody></table>';
            document.getElementById('dash-cardholder-table').innerHTML = chHtml;

            // Category table (clickable)
            let catHtml = '<table class="table table-dark-custom"><thead><tr><th>Category</th><th>Spent</th><th>Count</th></tr></thead><tbody>';
            (s.by_category || []).forEach(c => {
                catHtml += `<tr class="clickable-row" onclick="drillToTransactions({category:'${esc(c.category)}'})" title="Click to filter by category">
                <td>${c.category}</td>
                <td class="amount-negative">$${fmt(c.spent)}</td>
                <td>${c.cnt}</td>
            </tr>`;
            });
            catHtml += '</tbody></table>';
            document.getElementById('dash-category-table').innerHTML = catHtml;

            // Flagged preview
            const flagged = await api('/api/transactions?is_flagged=1' + getViewModeParam());
            let flHtml = '<table class="table table-dark-custom"><tbody>';
            flagged.slice(0, 10).forEach(t => {
                flHtml += `<tr class="clickable-row" onclick="editTransaction(${t.id})" title="${esc(t.flag_reason || '')}">
                <td>${t.trans_date || ''}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(t.description)}</td>
                <td class="amount-negative">$${fmt(Math.abs(t.amount))}</td>
            </tr>`;
            });
            if (flagged.length === 0) flHtml += '<tr><td class="text-muted text-center py-2">No flagged items</td></tr>';
            else if (flagged.length > 10) flHtml += `<tr><td colspan="3" class="text-center"><a href="#" onclick="drillToTransactions({is_flagged:'1'});return false;">View all ${flagged.length} flagged...</a></td></tr>`;
            flHtml += '</tbody></table>';
            document.getElementById('dash-flagged-table').innerHTML = flHtml;

            // Monthly chart (clickable)
            const maxM = Math.max(...(s.monthly_trend || []).map(m => Math.max(m.deposits, m.withdrawals)), 1);
            let mHtml = '<table class="table table-dark-custom"><thead><tr><th>Month</th><th>Deposits</th><th>Withdrawals</th><th>Transfers Out</th><th>Net</th><th style="width:30%">Visual</th></tr></thead><tbody>';
            (s.monthly_trend || []).forEach(m => {
                const dW = Math.round((m.deposits / maxM) * 200);
                const wW = Math.round((m.withdrawals / maxM) * 200);
                const net = m.deposits - m.withdrawals;
                mHtml += `<tr class="clickable-row" onclick="drillToMonth('${m.month}')" title="Click to see ${m.month} transactions">
                <td><strong>${m.month}</strong></td>
                <td class="amount-positive">$${fmt(m.deposits)}</td>
                <td class="amount-negative">$${fmt(m.withdrawals)}</td>
                <td class="amount-negative">$${fmt(m.transfers_out)}</td>
                <td class="${net < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(net))}</td>
                <td><div style="display:flex;gap:1px;align-items:center;"><div style="background:#3fb950;height:14px;width:${dW}px;border-radius:2px;"></div><div style="background:#f85149;height:14px;width:${wW}px;border-radius:2px;"></div></div></td>
            </tr>`;
            });
            mHtml += '</tbody></table>';
            document.getElementById('dash-monthly').innerHTML = mHtml;

            // Render Chart.js charts
            renderDashboardCharts(s);
        }

        function drillToMonth(month) {
            drillToTransactions({ date_from: month + '-01', date_to: month + '-31' });
        }

        // ===== TRANSACTIONS =====
        async function loadTransactions(filters) {
            await ensureCategories();
            if (!filters) filters = FilterStore.getState();

            const qs = serializeFilters(filters);
            const params = new URLSearchParams(qs);

            // Pagination support
            if (perPage > 0) {
                params.set('page', currentPage);
                params.set('per_page', perPage);
                const result = await api('/api/transactions?' + params.toString());
                allTransactions = result.transactions || result;
                totalPages = result.total_pages || 1;
                currentPage = result.page || 1;
                updatePagination(result.total || allTransactions.length);
            } else {
                allTransactions = await api('/api/transactions?' + params.toString());
                document.getElementById('pagination-controls').style.display = 'none';
            }
            selectedIds.clear();
            populateCardholderFilter();
            renderTransactions();
        }


        function renderTransactions() {
            const tbody = document.getElementById('transactions-tbody');
            let html = '', totalDebits = 0, totalCredits = 0;

            allTransactions.forEach(t => {
                if (t.amount < 0) totalDebits += Math.abs(t.amount); else totalCredits += t.amount;
                let tags = '';
                if (t.is_personal) tags += '<span class="badge badge-personal me-1">Personal</span>';
                if (t.is_business) tags += '<span class="badge badge-business me-1">Business</span>';
                if (t.is_transfer) tags += '<span class="badge badge-transfer me-1">Transfer</span>';
                if (t.is_flagged) tags += `<span class="badge badge-flagged me-1" title="${esc(t.flag_reason || '')}">FLAG</span>`;
                if (t.payment_method === 'venmo') tags += '<span class="badge badge-venmo me-1">Venmo</span>';

                // Confidences and UI Overrides
                let catUI = `<select class="category-select" style="max-width:200px;" onchange="quickCategory(${t.id}, this.value)">${categoryOptions(t.category)}</select>`;

                if (t.categorization_status === 'review_required' || t.categorization_status === 'suggested') {
                    const tip = t.categorization_explanation ? `title="AI Reason: ${esc(t.categorization_explanation)}"` : '';
                    catUI += `<div class="mt-1 d-flex align-items-center gap-1">`;
                    catUI += `<span class="badge bg-warning text-dark" style="font-size:0.6rem;" ${tip}><i class="fas fa-exclamation-triangle me-1"></i>Review</span>`;
                    catUI += `<button class="btn btn-sm btn-success py-0 px-1 ms-1" style="font-size:0.65rem;" onclick="approveCategory(${t.id})" title="Approve"><i class="fas fa-check"></i></button>`;
                    catUI += `</div>`;
                } else if (t.categorization_source === 'internet_lookup') {
                    catUI += `<div class="mt-1"><span class="badge bg-info text-dark" style="font-size:0.6rem;" title="Assisted by Web Search"><i class="fas fa-globe me-1"></i>Web Search</span></div>`;
                } else if (t.categorization_source === 'ai_high_conf') {
                    const tip = t.categorization_explanation ? `title="AI Reason: ${esc(t.categorization_explanation)}"` : '';
                    catUI += `<div class="mt-1"><span class="badge bg-success" style="font-size:0.6rem;" ${tip}><i class="fas fa-robot me-1"></i>AI Applied</span></div>`;
                }

                let tagAddDropdown = `
                <div class="dropdown d-inline-block">
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1 rounded-pill border-0" style="font-size:0.65rem;" data-bs-toggle="dropdown" title="Add Tag"><i class="fas fa-plus"></i></button>
                    <ul class="dropdown-menu dropdown-menu-dark text-small shadow" style="font-size:0.75rem;">
                        <li><a class="dropdown-item text-white" href="#" onclick="quickAddTag(${t.id}, 'is_personal'); return false;">Personal</a></li>
                        <li><a class="dropdown-item text-white" href="#" onclick="quickAddTag(${t.id}, 'is_business'); return false;">Business</a></li>
                        <li><a class="dropdown-item text-white" href="#" onclick="quickAddTag(${t.id}, 'is_transfer'); return false;">Transfer</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="quickAddTag(${t.id}, 'is_flagged'); return false;">Flagged</a></li>
                    </ul>
                </div>`;

                html += `<tr>
                <td class="checkbox-cell"><input type="checkbox" class="row-check" value="${t.id}" ${selectedIds.has(t.id) ? 'checked' : ''}></td>
                <td style="white-space:nowrap;font-size:0.75rem;">${t.trans_date || ''}</td>
                <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;" onclick="editTransaction(${t.id})" title="${esc(t.description)}${t.user_notes ? '\nNotes: ' + esc(t.user_notes) : ''}">${esc(t.description)}</td>
                <td class="${t.amount < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(t.amount))}</td>
                <td>${catUI}</td>
                <td style="font-size:0.75rem;">${esc(t.cardholder_name || '')}</td>
                <td style="font-size:0.75rem;">${t.card_last_four ? '#' + t.card_last_four : ''}</td>
                <td style="font-size:0.75rem;">${t.payment_method || ''}</td>
                <td style="white-space:nowrap;">${tags} ${tagAddDropdown}</td>
                <td>
                    <span class="quick-comment" id="note-display-${t.id}">
                        ${t.user_notes ? esc(t.user_notes) + ` <button class="btn btn-sm text-secondary p-0 border-0 ms-1" onclick="quickAddNote(${t.id})" title="Edit Note"><i class="fas fa-pencil-alt" style="font-size:0.65rem;"></i></button>`
                        : `<button class="btn btn-sm btn-outline-secondary py-0 px-1 rounded-pill" style="font-size:0.65rem;" onclick="quickAddNote(${t.id})"><i class="fas fa-plus me-1"></i>Note</button>`}
                    </span>
                </td>
                <td style="white-space:nowrap;">
                    <button class="btn btn-sm btn-outline-light py-0 px-1" onclick="editTransaction(${t.id})" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                    <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteTransaction(${t.id})" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                    <button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="toggleFlag(${t.id})" title="Flag"><i class="fas fa-flag fa-xs"></i></button>
                </td>
            </tr>`;
            });

            tbody.innerHTML = html || '<tr><td colspan="11" class="text-center text-muted py-4">No transactions found.</td></tr>';
            document.getElementById('trans-count').textContent = `${allTransactions.length} transactions`;
            document.getElementById('trans-total').textContent = `Debits: $${fmt(totalDebits)} | Credits: $${fmt(totalCredits)} | Net: $${fmt(totalCredits - totalDebits)}`;

            document.querySelectorAll('.row-check').forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) selectedIds.add(+cb.value); else selectedIds.delete(+cb.value);
                    updateBulkButtons();
                });
            });
        }

        document.getElementById('select-all').addEventListener('change', function () {
            document.querySelectorAll('.row-check').forEach(cb => { cb.checked = this.checked; if (this.checked) selectedIds.add(+cb.value); else selectedIds.delete(+cb.value); });
            updateBulkButtons();
        });
        function updateBulkButtons() { const show = selectedIds.size > 0; document.getElementById('bulk-delete-btn').style.display = show ? '' : 'none'; document.getElementById('bulk-edit-btn').style.display = show ? '' : 'none'; }

        async function quickCategory(id, cat) {
            const res = await api(`/api/transactions/${id}`, 'PUT', { category: cat });
            if (res.error) toast(res.error, "danger");
            else {
                toast('Updated');
                if (res.rule_suggestion) showRuleSuggestion(res.rule_suggestion);
            }
        }

        async function quickAddTag(id, tagKey) {
            const t = allTransactions.find(x => x.id === id);
            if (!t) return;
            // Prevent duplicate call if already set
            if (t[tagKey] === 1) return;

            t[tagKey] = 1; // Optimistic UI update
            const payload = {};
            payload[tagKey] = 1;

            const res = await api(`/api/transactions/${id}`, 'PUT', payload);
            if (res.error) {
                t[tagKey] = 0; // Rollback
                toast(res.error, "danger");
            } else {
                renderTransactions();
            }
        }

        function quickAddNote(id) {
            const t = allTransactions.find(x => x.id === id);
            if (!t) return;

            const container = document.getElementById(`note-display-${id}`);
            if (!container) return;

            const current = t.user_notes || '';
            const input = document.createElement('input');
            input.className = 'quick-comment-input form-control form-control-sm';
            input.style.cssText = 'min-width:150px; font-size:0.75rem; display:inline-block; width:auto;';
            input.value = current;
            input.placeholder = 'Type note & press Enter';

            // Avoid duplicate inputs
            if (container.querySelector('input')) return;

            container.innerHTML = '';
            container.appendChild(input);
            input.focus();

            let isSaving = false;

            const save = async () => {
                if (isSaving) return;
                isSaving = true;

                const newVal = input.value.trim();
                // If unchanged, just restore UI
                if (newVal === current) {
                    renderTransactions();
                    return;
                }

                const res = await api(`/api/transactions/${id}`, 'PUT', { user_notes: newVal });
                if (res.error) {
                    toast(res.error, "danger");
                } else {
                    t.user_notes = newVal;
                }
                renderTransactions();
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                if (e.key === 'Escape') { input.value = current; input.blur(); }
            });
        }
        async function toggleFlag(id) { const t = allTransactions.find(x => x.id === id); if (!t) return; await api(`/api/transactions/${id}`, 'PUT', { is_flagged: t.is_flagged ? 0 : 1 }); loadTransactions(); toast(t.is_flagged ? 'Unflagged' : 'Flagged'); }

        async function approveCategory(id) {
            const res = await api(`/api/transactions/${id}`, 'PUT', { categorization_status: 'auto_applied', manually_edited: 1 });
            if (res.error) toast(res.error, "danger");
            else {
                toast('Category Approved');
                // The item is now manually_edited=1, meaning explicit Rank 1 override is technically formed here on next AI pass
                loadTransactions();
            }
        }

        async function editTransaction(id) {
            // Find in current list or fetch
            let t = allTransactions.find(x => x.id === id);
            if (!t) { toast('Transaction not found in current view'); return; }
            editingId = id;

            // Load proof documents for this transaction
            const proofs = await api(`/api/transactions/${id}/proofs`);
            const allDocs = await api('/api/documents');
            const proofDocs = allDocs.filter(d => d.doc_category === 'proof');

            let proofsHtml = '<div class="proof-section"><label class="form-label small fw-bold"><i class="fas fa-paperclip me-1"></i>Proof Documents</label>';
            if (proofs.length > 0) {
                proofsHtml += '<div class="mb-2">';
                proofs.forEach(p => {
                    proofsHtml += `<div class="proof-item"><a href="/uploads/${encodeURIComponent(p.filename)}" target="_blank"><i class="fas fa-file me-1"></i>${esc(p.filename)}</a><button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="unlinkProof(${id},${p.id})"><i class="fas fa-unlink fa-xs"></i></button></div>`;
                });
                proofsHtml += '</div>';
            } else {
                proofsHtml += '<div class="text-muted small mb-2">No proof documents linked</div>';
            }
            if (proofDocs.length > 0) {
                proofsHtml += `<div class="d-flex gap-2"><select class="form-select form-select-sm" id="edit-proof-select" style="max-width:250px;"><option value="">-- Link a proof doc --</option>`;
                proofDocs.forEach(d => {
                    const alreadyLinked = proofs.some(p => p.id === d.id);
                    if (!alreadyLinked) proofsHtml += `<option value="${d.id}">${esc(d.filename)}</option>`;
                });
                proofsHtml += `</select><button class="btn btn-sm btn-info" onclick="linkProofFromEdit(${id})"><i class="fas fa-link"></i></button></div>`;
            }
            proofsHtml += '</div>';

            let aiReasoningHtml = '';
            if (t.categorization_status || t.categorization_source || t.categorization_explanation) {
                let sBadge = t.categorization_status === 'auto_applied' ? '<span class="badge bg-success ms-2">Applied</span>' :
                    t.categorization_status === 'suggested' ? '<span class="badge bg-warning text-dark ms-2">Suggested</span>' :
                        t.categorization_status === 'review_required' ? '<span class="badge bg-danger ms-2">Needs Review</span>' : '';

                let srcInfo = t.categorization_source === 'internet_lookup' ? 'Web Assisted AI' :
                    t.categorization_source === 'ai_high_conf' ? 'AI Inference' :
                        t.categorization_source === 'user_rule' ? 'Explicit Rule' :
                            t.categorization_source === 'learned_rule' ? 'Soft-Learned Rule' :
                                t.categorization_source === 'merchant_mapping' ? 'Known Merchant' : t.categorization_source || 'Unknown';

                aiReasoningHtml = `
                    <div class="card bg-dark border-secondary mb-3 mt-2">
                        <div class="card-header py-1 small fw-bold text-info"><i class="fas fa-brain me-2"></i>Categorization Context</div>
                        <div class="card-body py-2 small">
                            <div class="row">
                                <div class="col-6 mb-1"><strong>Source:</strong> ${srcInfo}</div>
                                <div class="col-6 mb-1"><strong>Status:</strong> ${t.categorization_status || 'N/A'} ${sBadge}</div>
                                <div class="col-6 mb-1"><strong>Confidence:</strong> ${t.categorization_confidence ? (t.categorization_confidence * 100).toFixed(0) + '%' : 'N/A'}</div>
                                <div class="col-6 mb-1"><strong>Manual Override:</strong> ${t.manually_edited ? 'Yes' : 'No'}</div>
                                ${t.categorization_explanation ? `<div class="col-12 mt-1"><strong>Reasoning:</strong><br><span class="text-muted" style="white-space:pre-wrap;">${esc(t.categorization_explanation)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('edit-form-body').innerHTML = `
            ${aiReasoningHtml}
            <div class="row g-2">
                <div class="col-6 mb-2"><label class="form-label small">Date</label><input type="text" class="form-control form-control-sm" id="edit-date" value="${t.trans_date || ''}"></div>
                <div class="col-6 mb-2"><label class="form-label small">Amount</label><input type="number" step="0.01" class="form-control form-control-sm" id="edit-amount" value="${t.amount}"></div>
            </div>
            <div class="mb-2"><label class="form-label small">Description</label><input type="text" class="form-control form-control-sm" id="edit-desc" value="${esc(t.description)}"></div>
            <div class="mb-2"><label class="form-label small">Category</label><select class="form-select form-select-sm" id="edit-category">${categoryOptions(t.category)}</select></div>
            <div class="row g-2">
                <div class="col-6 mb-2"><label class="form-label small">Cardholder</label><input type="text" class="form-control form-control-sm" id="edit-cardholder" value="${esc(t.cardholder_name || '')}"></div>
                <div class="col-3 mb-2"><label class="form-label small">Card #</label><input type="text" class="form-control form-control-sm" id="edit-card4" value="${t.card_last_four || ''}" maxlength="4"></div>
                <div class="col-3 mb-2"><label class="form-label small">Method</label><select class="form-select form-select-sm" id="edit-method"><option value="">--</option>${['debit', 'credit', 'check', 'venmo', 'transfer', 'wire', 'cash'].map(m => `<option ${t.payment_method === m ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
            </div>
            <div class="mb-2"><label class="form-label small">Notes</label><input type="text" class="form-control form-control-sm" id="edit-notes" value="${esc(t.user_notes || '')}"></div>
            <label class="form-label small mb-1">Tags</label>
            <div class="d-flex flex-wrap gap-2 mb-2">
                <input type="checkbox" class="btn-check" id="edit-personal" autocomplete="off" ${t.is_personal ? 'checked' : ''}>
                <label class="btn btn-outline-info btn-sm rounded-pill px-3" for="edit-personal"><i class="fas fa-user me-1"></i>Personal</label>

                <input type="checkbox" class="btn-check" id="edit-business" autocomplete="off" ${t.is_business ? 'checked' : ''}>
                <label class="btn btn-outline-warning btn-sm rounded-pill px-3" for="edit-business"><i class="fas fa-briefcase me-1"></i>Business</label>

                <input type="checkbox" class="btn-check" id="edit-transfer" autocomplete="off" ${t.is_transfer ? 'checked' : ''}>
                <label class="btn btn-outline-secondary btn-sm rounded-pill px-3" for="edit-transfer"><i class="fas fa-exchange-alt me-1"></i>Transfer</label>

                <input type="checkbox" class="btn-check" id="edit-flagged" autocomplete="off" ${t.is_flagged ? 'checked' : ''}>
                <label class="btn btn-outline-danger btn-sm rounded-pill px-3" for="edit-flagged"><i class="fas fa-flag me-1"></i>Flagged</label>
            </div>
            <div class="mb-0"><label class="form-label small">Flag Reason</label><input type="text" class="form-control form-control-sm" id="edit-flag-reason" value="${esc(t.flag_reason || '')}"></div>
            ${proofsHtml}
        `;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function linkProofFromEdit(transId) {
            const sel = document.getElementById('edit-proof-select');
            if (!sel || !sel.value) return;
            await api(`/api/transactions/${transId}/proofs`, 'POST', { document_id: parseInt(sel.value) });
            toast('Proof linked');
            // Refresh the edit modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            if (modal) modal.hide();
            editTransaction(transId);
        }

        async function unlinkProof(transId, docId) {
            await api(`/api/transactions/${transId}/proofs/${docId}`, 'DELETE');
            toast('Proof unlinked');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            if (modal) modal.hide();
            editTransaction(transId);
        }

        async function saveTransaction() {
            const result = await api(`/api/transactions/${editingId}`, 'PUT', {
                trans_date: document.getElementById('edit-date').value,
                description: document.getElementById('edit-desc').value,
                amount: parseFloat(document.getElementById('edit-amount').value),
                category: document.getElementById('edit-category').value,
                cardholder_name: document.getElementById('edit-cardholder').value,
                card_last_four: document.getElementById('edit-card4').value,
                payment_method: document.getElementById('edit-method').value,
                user_notes: document.getElementById('edit-notes').value,
                is_personal: document.getElementById('edit-personal').checked ? 1 : 0,
                is_business: document.getElementById('edit-business').checked ? 1 : 0,
                is_transfer: document.getElementById('edit-transfer').checked ? 1 : 0,
                is_flagged: document.getElementById('edit-flagged').checked ? 1 : 0,
                flag_reason: document.getElementById('edit-flag-reason').value,
            });
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            loadTransactions(); toast('Saved');

            // Show rule suggestion if available
            if (result && result.rule_suggestion) {
                showRuleSuggestion(result.rule_suggestion);
            }
        }

        function showRuleSuggestion(suggestion) {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'rule-suggestion';
            el.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong class="text-info"><i class="fas fa-lock me-1"></i> Remember this Choice (Override)?</strong>
                <button class="btn btn-sm btn-outline-light py-0 px-1 rule-dismiss"><i class="fas fa-times fa-xs"></i></button>
            </div>
            <div class="mb-2">Pattern: <code>${esc(suggestion.pattern)}</code> &rarr; <strong>${esc(suggestion.category)}</strong></div>
            <div class="small text-muted mb-2">Protects this vendor from future AI re-classifications.</div>
            <button class="btn btn-sm btn-info rule-accept"><i class="fas fa-check me-1"></i>Save Override</button>
            <button class="btn btn-sm btn-outline-light rule-dismiss">Dismiss</button>
        `;
            el.querySelectorAll('.rule-dismiss').forEach(b => b.addEventListener('click', () => el.remove()));
            el.querySelector('.rule-accept').addEventListener('click', async function () {
                await api('/api/categories/rules', 'POST', {
                    pattern: suggestion.pattern,
                    category: suggestion.category,
                    priority: 100,
                    is_personal: suggestion.is_personal,
                    is_business: suggestion.is_business,
                    is_transfer: suggestion.is_transfer
                });
                el.remove();
                toast('Override Rule created! Run Re-categorize to apply.');
            });
            c.appendChild(el);
            setTimeout(() => { if (el.parentNode) el.remove(); }, 15000);
        }

        async function deleteTransaction(id) { if (!confirm('Delete this transaction?')) return; await api(`/api/transactions/${id}`, 'DELETE'); loadTransactions(); toast('Deleted'); }
        async function bulkDelete() { if (!confirm(`Delete ${selectedIds.size} transactions?`)) return; for (const id of selectedIds) await api(`/api/transactions/${id}`, 'DELETE'); selectedIds.clear(); loadTransactions(); toast('Deleted'); }
        function showBulkEditModal() { document.getElementById('bulk-count').textContent = `(${selectedIds.size})`; loadCategoryOptions('bulk-category', true); new bootstrap.Modal(document.getElementById('bulkEditModal')).show(); }
        async function saveBulkEdit() {
            const fields = {};
            const cat = document.getElementById('bulk-category').value; if (cat) fields.category = cat;
            if (document.getElementById('bulk-personal').checked) fields.is_personal = 1;
            if (document.getElementById('bulk-business').checked) fields.is_business = 1;
            if (document.getElementById('bulk-transfer').checked) fields.is_transfer = 1;
            if (document.getElementById('bulk-flagged').checked) fields.is_flagged = 1;
            const n = document.getElementById('bulk-notes').value; if (n) fields.user_notes = n;
            await api('/api/transactions/bulk', 'POST', { ids: [...selectedIds], fields });
            bootstrap.Modal.getInstance(document.getElementById('bulkEditModal')).hide();
            selectedIds.clear(); loadTransactions(); toast('Updated');
        }
        function showAddTransactionModal() { loadCategoryOptions('add-category'); new bootstrap.Modal(document.getElementById('addTransModal')).show(); }
        async function addManualTransaction() {
            await api('/api/add-transaction', 'POST', {
                trans_date: document.getElementById('add-date').value, description: document.getElementById('add-desc').value,
                amount: parseFloat(document.getElementById('add-amount').value), category: document.getElementById('add-category').value,
                cardholder_name: document.getElementById('add-cardholder').value, card_last_four: document.getElementById('add-card').value,
                payment_method: document.getElementById('add-method').value,
                is_personal: document.getElementById('add-personal').checked ? 1 : 0, is_business: document.getElementById('add-business').checked ? 1 : 0, is_transfer: document.getElementById('add-transfer').checked ? 1 : 0,
            });
            bootstrap.Modal.getInstance(document.getElementById('addTransModal')).hide(); loadTransactions(); toast('Added');
        }

        // ===== FORENSIC ANALYSIS =====
        async function loadAnalysis(filters) {
            if (!filters) filters = FilterStore.getState();

            // Strip out restrictive drilldown filters for the deposit analysis so it isn't starved of deposits
            const safeFilters = { ...filters };
            delete safeFilters.category;
            delete safeFilters.trans_type;
            delete safeFilters.search;
            const safeQs = serializeFilters(safeFilters);

            // Deposit-transfer patterns
            const patterns = await api('/api/analysis/deposit-transfers?' + safeQs);
            let dtHtml = '<table class="table table-dark-custom"><thead><tr><th>Deposit Date</th><th>Deposit Amt</th><th>Transfers Within 7 Days</th><th>Total Moved</th><th>% Moved</th></tr></thead><tbody>';
            if (!patterns.length) dtHtml += '<tr><td colspan="5" class="text-center text-muted py-3">No patterns detected. Upload bank statements to analyze.</td></tr>';
            patterns.forEach(p => {
                const cls = p.pct_transferred > 50 ? 'text-danger fw-bold' : p.pct_transferred > 25 ? 'text-warning' : '';
                dtHtml += `<tr><td>${p.deposit.trans_date}</td><td class="amount-positive">$${fmt(p.deposit_amount)}</td>
                <td>${p.transfers.map(t => `<div class="small">${t.trans_date}: ${esc(t.description).substring(0, 50)} <span class="amount-negative">$${fmt(Math.abs(t.amount))}</span></div>`).join('')}</td>
                <td class="amount-negative">$${fmt(p.transfer_total)}</td><td class="${cls}">${p.pct_transferred}%</td></tr>`;
            });
            dtHtml += '</tbody></table>';
            document.getElementById('deposit-transfer-analysis').innerHTML = dtHtml;

            // Flagged
            const flagged = await api('/api/transactions?is_flagged=1' + getViewModeParam());
            let flHtml = '<table class="table table-dark-custom"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Cardholder</th><th>Reason</th><th>Actions</th></tr></thead><tbody>';
            flagged.forEach(t => {
                flHtml += `<tr><td>${t.trans_date}</td><td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(t.description)}</td>
                <td class="${t.amount < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(t.amount))}</td>
                <td>${esc(t.cardholder_name || '')}</td><td class="text-warning small">${esc(t.flag_reason || '')}</td>
                <td><button class="btn btn-sm btn-outline-light py-0 px-1" onclick="editTransaction(${t.id});allTransactions=window._flaggedTrans;"><i class="fas fa-edit fa-xs"></i></button></td></tr>`;
            });
            if (!flagged.length) flHtml += '<tr><td colspan="6" class="text-muted text-center py-3">No flagged transactions</td></tr>';
            flHtml += '</tbody></table>';
            document.getElementById('flagged-transactions').innerHTML = flHtml;
            // Make flagged available for editing
            window._flaggedTrans = flagged;

            // Venmo analysis - Find transactions mathematically mapped to Venmo category OR containing Venmo
            const venmo = await api('/api/transactions?category=Venmo+-+Payment' + getViewModeParam().replace('?', '&'));
            let vHtml = '<table class="table table-dark-custom"><thead><tr><th>Date</th><th>Recipient</th><th>Amount</th><th>Note/Description</th><th>Flagged</th></tr></thead><tbody>';
            let venmoTotal = 0;
            const venmoByPerson = {};
            venmo.forEach(t => {
                venmoTotal += Math.abs(t.amount);
                const name = t.cardholder_name || 'Unknown';
                venmoByPerson[name] = (venmoByPerson[name] || 0) + Math.abs(t.amount);
                vHtml += `<tr><td>${t.trans_date}</td><td>${esc(t.cardholder_name || '')}</td>
                <td class="amount-negative">$${fmt(Math.abs(t.amount))}</td>
                <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(t.description)}</td>
                <td>${t.is_flagged ? '<span class="badge badge-flagged">FLAG</span>' : ''}</td></tr>`;
            });
            vHtml += `</tbody></table>`;

            // Venmo summary by person
            let vSummary = `<div class="p-3 mb-2"><strong>Total Venmo: <span class="amount-negative">$${fmt(venmoTotal)}</span></strong> across ${venmo.length} payments</div>`;
            vSummary += '<div class="px-3 pb-2"><strong>By Recipient:</strong></div><div class="px-3 pb-2">';
            Object.entries(venmoByPerson).sort((a, b) => b[1] - a[1]).forEach(([name, total]) => {
                vSummary += `<span class="badge bg-secondary me-1 mb-1" style="cursor:pointer;" onclick="drillToTransactions({search:'VENMO',cardholder:'${esc(name)}'})">${name}: $${fmt(total)}</span>`;
            });
            vSummary += '</div>';

            document.getElementById('venmo-analysis').innerHTML = vSummary + vHtml;
        }

        // Old cardholders function removed - replaced by enhanced version below

        // ===== ACCOUNTS =====
        async function loadAccounts() {
            const accounts = await api('/api/accounts');
            let html = '<div class="row g-3">';
            for (const acct of accounts) {
                const typeClass = acct.account_type === 'bank' ? 'bank' : acct.account_type === 'venmo' ? 'venmo' : 'credit';
                const icon = acct.account_type === 'bank' ? 'university' : acct.account_type === 'venmo' ? 'mobile-alt' : 'credit-card';
                html += `<div class="col-md-4"><div class="card-dark p-3">
                <div class="account-card ${typeClass}">
                    <h6><i class="fas fa-${icon} me-1"></i> ${esc(acct.account_name)}</h6>
                    <div class="small text-muted">${esc(acct.institution || '')} | #${esc(acct.account_number || '')}</div>
                    <div class="small text-muted">Type: ${acct.account_type} ${acct.cardholder_name ? '| ' + esc(acct.cardholder_name) : ''}</div>
                    <button class="btn btn-sm btn-outline-light mt-2 me-1" onclick="drillToTransactions({account_id:'${acct.id}'})"><i class="fas fa-list"></i> Transactions</button>
                    <button class="btn btn-sm btn-outline-info mt-2" onclick="showRunningBalance(${acct.id}, '${esc(acct.account_name)}')"><i class="fas fa-chart-area"></i> Balance</button>
                </div>
            </div></div>`;
            }
            html += '</div>';
            document.getElementById('accounts-content').innerHTML = html || '<p class="text-muted">No accounts.</p>';
        }

        // ===== UPLOAD =====
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        async function handleFiles(files) {
            const statusEl = document.getElementById('upload-status');
            const previewEl = document.getElementById('upload-preview');
            const resultsEl = document.getElementById('upload-results');
            const uploadZone = document.getElementById('upload-zone');

            uploadZone.style.pointerEvents = 'none';
            uploadZone.style.opacity = '0.6';

            for (const file of files) {
                statusEl.innerHTML = `<div class="alert alert-info small py-2"><i class="fas fa-spinner fa-spin"></i> Processing ${esc(file.name)}... please wait.</div>`;
                previewEl.style.display = 'none';

                const fd = new FormData();
                fd.append('file', file);
                fd.append('doc_type', document.getElementById('upload-doc-type').value);
                fd.append('doc_category', document.getElementById('upload-doc-category').value);

                try {
                    const resp = await fetch('/api/upload/preview', { method: 'POST', body: fd });
                    const data = await resp.json();

                    if (data.error) {
                        statusEl.innerHTML = `<div class="alert alert-danger small py-2"><i class="fas fa-times-circle"></i> ${esc(file.name)}: ${data.error}</div>`;
                        continue;
                    }

                    if (data.mode === 'proof') {
                        statusEl.innerHTML = '';
                        resultsEl.innerHTML += `<div class="alert alert-success small py-2"><i class="fas fa-check-circle"></i> ${esc(file.name)}: Proof document uploaded</div>`;
                        continue;
                    }

                    // Show preview
                    currentPreviewId = data.preview_id;
                    let dupWarning = data.duplicate_count > 0 ? ` <span class="text-warning fw-bold">WARNING: ${data.duplicate_count} potential duplicate(s) detected (shown struck-through).</span>` : '';
                    statusEl.innerHTML = `<div class="alert alert-info small py-2"><i class="fas fa-eye"></i> ${esc(file.name)}: ${data.transaction_count} transactions found.${dupWarning} Review below and commit.</div>`;

                    await ensureCategories();
                    let previewHtml = `<div class="preview-panel">
                    <div class="preview-header">
                        <h6 class="mb-0"><i class="fas fa-table me-1"></i> Preview: ${esc(data.filename)} (${data.transaction_count} transactions)</h6>
                        <div>
                            <button class="btn btn-sm btn-success me-1" id="btn-commit-upload" onclick="commitUpload()"><i class="fas fa-check"></i> Commit</button>
                            <button class="btn btn-sm btn-outline-danger" id="btn-cancel-upload" onclick="cancelUpload()"><i class="fas fa-times"></i> Cancel</button>
                        </div>
                    </div>
                    <div class="scrollable-table"><table class="table table-dark-custom">
                    <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Category</th><th>Type</th><th>Cardholder</th><th>Tags</th></tr></thead><tbody>`;

                    (data.transactions || []).forEach((t, i) => {
                        let tags = '';
                        if (t.is_personal) tags += '<span class="badge badge-personal me-1">P</span>';
                        if (t.is_business) tags += '<span class="badge badge-business me-1">B</span>';
                        if (t.is_transfer) tags += '<span class="badge badge-transfer me-1">T</span>';
                        if (t.is_flagged) tags += '<span class="badge badge-flagged me-1">FLAG</span>';
                        if (t._is_duplicate) tags += '<span class="badge bg-warning text-dark me-1" title="Duplicate of existing transaction">DUP</span>';
                        if (t._source_file) tags += `<span class="badge bg-secondary me-1" title="Extracted from ${esc(t._source_file)}"><i class="fas fa-file-archive me-1"></i>${esc(t._source_file)}</span>`;

                        previewHtml += `<tr class="${t._is_duplicate ? 'duplicate-row' : ''}">
                        <td style="white-space:nowrap;font-size:0.75rem;">${t.trans_date || ''}</td>
                        <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(t.description)}">${esc(t.description)}</td>
                        <td class="${t.amount < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(t.amount))}</td>
                        <td><select class="category-select preview-cat" data-idx="${i}">${categoryOptions(t.category)}</select></td>
                        <td style="font-size:0.75rem;">${t.trans_type || ''}</td>
                        <td style="font-size:0.75rem;">${esc(t.cardholder_name || '')}</td>
                        <td style="white-space:nowrap;">${tags}</td>
                    </tr>`;
                    });

                    previewHtml += '</tbody></table></div></div>';
                    if (data.skipped_duplicate_files > 0) {
                        previewHtml += `<div class="alert alert-warning small py-2 mt-2 mb-0"><i class="fas fa-exclamation-triangle"></i> <strong>${data.skipped_duplicate_files} documents</strong> in this ZIP were skipped because identical documents are already in your account.</div>`;
                    }
                    previewEl.innerHTML = previewHtml;
                    previewEl.style.display = 'block';
                    previewEl._transactions = data.transactions;

                } catch (err) {
                    statusEl.innerHTML = `<div class="alert alert-danger small py-2"><i class="fas fa-times-circle"></i> ${esc(file.name)}: ${err.message}</div>`;
                }
            }
            fileInput.value = '';
            uploadZone.style.pointerEvents = 'auto';
            uploadZone.style.opacity = '1';
        }

        async function commitUpload() {
            if (!currentPreviewId) return;
            const previewEl = document.getElementById('upload-preview');
            const statusEl = document.getElementById('upload-status');
            const resultsEl = document.getElementById('upload-results');

            const btnCommit = document.getElementById('btn-commit-upload');
            const btnCancel = document.getElementById('btn-cancel-upload');
            if (btnCommit) { btnCommit.disabled = true; btnCommit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Committing...'; }
            if (btnCancel) btnCancel.disabled = true;

            // Gather updated categories from preview selects
            const transactions = previewEl._transactions || [];
            document.querySelectorAll('.preview-cat').forEach(sel => {
                const idx = parseInt(sel.dataset.idx);
                if (transactions[idx]) transactions[idx].category = sel.value;
            });

            statusEl.innerHTML = `<div class="alert alert-info small py-2"><i class="fas fa-spinner fa-spin"></i> Committing transactions safely to the database...</div>`;

            const data = await api('/api/upload/commit', 'POST', { preview_id: currentPreviewId, transactions });
            if (data.error) {
                statusEl.innerHTML = `<div class="alert alert-danger small py-2"><i class="fas fa-times-circle"></i> ${esc(data.error)}</div>`;
                if (btnCommit) { btnCommit.disabled = false; btnCommit.innerHTML = '<i class="fas fa-check"></i> Commit'; }
                if (btnCancel) btnCancel.disabled = false;
            } else {
                statusEl.innerHTML = '';
                previewEl.style.display = 'none';
                let successMsg = `${data.transactions_added} imported`;
                if (data.transactions_skipped > 0) {
                    successMsg += `, ${data.transactions_skipped} skipped as duplicates`;
                }
                resultsEl.innerHTML += `<div class="alert alert-success small py-2"><i class="fas fa-check-circle"></i> ${esc(data.filename)}: ${successMsg}</div>`;
                toast(`Imported ${data.transactions_added} transactions`);
            }
            currentPreviewId = null;
        }

        async function cancelUpload() {
            if (!currentPreviewId) return;
            const btnCancel = document.getElementById('btn-cancel-upload');
            const btnCommit = document.getElementById('btn-commit-upload');
            if (btnCancel) { btnCancel.disabled = true; btnCancel.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
            if (btnCommit) btnCommit.disabled = true;

            await api('/api/upload/cancel', 'POST', { preview_id: currentPreviewId });
            document.getElementById('upload-preview').style.display = 'none';
            document.getElementById('upload-status').innerHTML = '<div class="alert alert-warning small py-2"><i class="fas fa-ban"></i> Upload cancelled</div>';
            currentPreviewId = null;
        }

        // ===== DOCUMENTS =====
        async function loadDocuments() {
            const docs = await api('/api/documents');
            let html = '';

            const roots = [];
            const childrenMap = {};
            docs.forEach(d => {
                if (d.parent_document_id) {
                    if (!childrenMap[d.parent_document_id]) childrenMap[d.parent_document_id] = [];
                    childrenMap[d.parent_document_id].push(d);
                } else {
                    roots.push(d);
                }
            });

            function renderDoc(d, isChild = false) {
                const icon = d.file_type === 'pdf' ? 'fa-file-pdf text-danger' : d.file_type === 'xlsx' ? 'fa-file-excel text-success' : d.file_type === 'docx' ? 'fa-file-word text-primary' : d.file_type === 'zip' ? 'fa-file-archive text-warning' : 'fa-file text-info';

                let sClass = 'secondary';
                if (d.status === 'processing' || d.status === 'queued') sClass = 'warning text-dark';
                else if (d.status === 'approved' || d.status === 'imported' || d.status === 'completed') sClass = 'success';
                else if (d.status === 'failed') sClass = 'danger';

                let actionHtml = '';
                if (d.status === 'pending_approval') {
                    actionHtml += `<button class="btn btn-sm btn-success py-0 px-2 me-1 action-btn" onclick="event.stopPropagation(); approveDocument('${d.id}', this)" title="Approve Document"><i class="fas fa-check"></i> Approve</button>`;
                }
                actionHtml += `<button class="btn btn-sm btn-outline-danger py-0 px-2 action-btn" onclick="event.stopPropagation(); deleteDocument('${d.id}', this)" title="Delete Document & Truncate Orphan Data"><i class="fas fa-trash"></i></button>`;

                const indent = isChild ? '<span style="margin-left: 1.5rem; border-left: 2px solid #4a5568; padding-left: 10px;"></span>' : '';

                let tr = `<tr class="clickable-row ${isChild ? 'child-doc' : 'parent-doc'}" onclick="drillToTransactions({document_id: '${d.id}'})" title="View transactions imported from this document">
                <td>${indent}<a href="/uploads/${encodeURIComponent(d.filename)}" target="_blank" onclick="event.stopPropagation()"><i class="fas ${icon} me-1"></i>${esc(d.filename)}</a></td>
                <td>${d.file_type}</td><td>${d.doc_category || ''}</td><td>${d.account_name || ''}</td>
                <td><span class="badge bg-${sClass}">${d.status || 'queued'}</span></td>
                <td>${d.parsed_transaction_count || 0}</td>
                <td class="text-success fw-bold">${d.import_transaction_count || 0}</td>
                <td class="text-warning">${d.deduped_skipped_count || 0}</td>
                <td>${(d.upload_date || '').substring(0, 16)}</td>
                <td>${actionHtml}</td>
                </tr>`;

                const children = Object.values(childrenMap[d.id] || []).sort((a, b) => (a.filename > b.filename) ? 1 : -1);
                children.forEach(c => { tr += renderDoc(c, true); });
                return tr;
            }

            roots.forEach(d => { html += renderDoc(d, false); });
            document.getElementById('documents-tbody').innerHTML = html || '<tr><td colspan="10" class="text-muted text-center py-3">No documents uploaded.</td></tr>';
        }

        async function approveDocument(docId, btn) {
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
            try {
                toast("Approving document...", "info");
                const res = await api(`/api/documents/${docId}/approve`, 'POST');
                if (res.error) {
                    toast(res.error, "danger");
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check"></i> Approve'; }
                } else {
                    toast(`Approved successfully. ${res.transactions_approved} transactions activated.`, "success");
                    loadDocuments();
                    loadAnalytics();
                }
            } catch (e) {
                toast("Error approving document.", "danger");
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check"></i> Approve'; }
            }
        }

        async function deleteDocument(docId, btn) {
            if (!confirm("Deleting this document will remove the document and any transactions/data imported from it.")) return;
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
            try {
                toast("Deleting document...", "info");
                const res = await api(`/api/documents/${docId}`, 'DELETE');
                if (res.error) {
                    toast(res.error, "danger");
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-trash"></i>'; }
                } else {
                    toast(`Document deleted successfully.`, "success");
                    loadDocuments();
                    loadAnalytics();
                }
            } catch (e) {
                toast("Error deleting document.", "danger");
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-trash"></i>'; }
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Are you sure you want to delete this category?')) return;
            try {
                const res = await api('/api/categories/' + id, 'DELETE');
                if (res.error) toast(res.error, "danger");
                else {
                    toast('Category deleted', 'success');
                    allCategories = []; // Force reload
                    loadCategoriesPage();
                }
            } catch (e) {
                toast('Error deleting category', 'danger');
            }
        }

        async function deleteRule(id) {
            if (!confirm('Are you sure you want to delete this rule?')) return;
            try {
                const res = await api('/api/categories/rules/' + id, 'DELETE');
                if (res.error) toast(res.error, "danger");
                else {
                    toast('Rule deleted', 'success');
                    loadCategoriesPage();
                }
            } catch (e) {
                toast('Error deleting rule', 'danger');
            }
        }

        async function restoreCategoriesDefaults() {
            if (!confirm('WARNING: This will permanently delete all your existing categories and rules, and replace them with the 25 standard defaults. Are you sure you want to proceed?')) return;
            try {
                toast("Restoring default categories...", "info");
                const res = await api('/api/categories/restore-defaults', 'POST');
                if (res.error) toast(res.error, "danger");
                else {
                    toast('Default categories and rules restored successfully.', 'success');
                    allCategories = []; // Force reload
                    loadCategoriesPage();
                }
            } catch (e) {
                toast('Error restoring categories', 'danger');
            }
        }

        // ===== CATEGORIES =====
        async function loadCategoriesPage() {
            await ensureCategories();
            let catHtml = '<table class="table table-dark-custom"><thead><tr><th>Name</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
            allCategories.forEach(c => { catHtml += `<tr class="clickable-row" onclick="drillToTransactions({category:'${esc(c.name)}'})"><td><span style="color:${c.color}"><i class="fas fa-${c.icon || 'tag'}"></i></span> ${c.name}</td><td>${c.category_type || ''}</td><td><button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="event.stopPropagation(); deleteCategory(${c.id})"><i class="fas fa-trash"></i></button></td></tr>`; });
            catHtml += '</tbody></table>';
            document.getElementById('categories-list').innerHTML = catHtml;

            const rules = await api('/api/categories/rules');
            let rHtml = '<table class="table table-dark-custom"><thead><tr><th>Pattern</th><th>Category</th><th>P</th><th>B</th><th>T</th><th>Priority</th><th>Actions</th></tr></thead><tbody>';
            rules.forEach(r => { rHtml += `<tr class="clickable-row" onclick="drillToTransactions({category:'${esc(r.category)}'})"><td><code style="color:#79c0ff;">${esc(r.pattern)}</code></td><td>${r.category}</td><td>${r.is_personal ? '<i class="fas fa-check text-warning"></i>' : ''}</td><td>${r.is_business ? '<i class="fas fa-check text-info"></i>' : ''}</td><td>${r.is_transfer ? '<i class="fas fa-check text-danger"></i>' : ''}</td><td>${r.priority}</td><td><button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="event.stopPropagation(); deleteRule(${r.id})"><i class="fas fa-trash"></i></button></td></tr>`; });
            rHtml += '</tbody></table>';
            document.getElementById('rules-list').innerHTML = rHtml;

            const taxonomy = await api('/api/taxonomy');
            let taxHtml = '<table class="table table-dark-custom"><thead><tr><th>Name</th><th>Description</th><th>Type</th><th>Severity</th><th>Actions</th></tr></thead><tbody>';
            if (taxonomy && taxonomy.length > 0) {
                taxonomy.forEach(t => {
                    taxHtml += `<tr>
                        <td class="fw-bold">${esc(t.name)}</td>
                        <td>${esc(t.description || '')}</td>
                        <td><span class="badge bg-secondary">${esc(t.category_type || '')}</span></td>
                        <td><span class="badge ${t.severity === 'high' || t.severity === 'critical' ? 'bg-danger' : t.severity === 'medium' ? 'bg-warning text-dark' : 'bg-info'}">${t.severity}</span></td>
                        <td><button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="deleteTaxonomy(${t.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            } else {
                taxHtml += '<tr><td colspan="5" class="text-center text-muted">No taxonomy rules defined. System will use defaults.</td></tr>';
            }
            taxHtml += '</tbody></table>';
            document.getElementById('taxonomy-list').innerHTML = taxHtml;
        }

        function showAddRuleModal() { loadCategoryOptions('rule-category'); new bootstrap.Modal(document.getElementById('addRuleModal')).show(); }
        function showAddCategoryModal() {
            document.getElementById('new-cat-name').value = '';
            document.getElementById('new-cat-parent').value = '';
            document.getElementById('new-cat-type').value = 'other';
            document.getElementById('new-cat-color').value = '#6c757d';
            document.getElementById('new-cat-icon').value = 'tag';
            new bootstrap.Modal(document.getElementById('addCategoryModal')).show();
        }

        async function saveCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            if (!name) return showToast('Category name is required', 'danger');

            try {
                const res = await api('/api/categories', 'POST', {
                    name,
                    parent_category: document.getElementById('new-cat-parent').value.trim() || null,
                    category_type: document.getElementById('new-cat-type').value,
                    color: document.getElementById('new-cat-color').value,
                    icon: document.getElementById('new-cat-icon').value.trim() || 'tag'
                });

                if (res.error) throw new Error(res.error);

                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                showToast('Category added successfully', 'success');
                allCategories = await api('/api/categories');

                // Update dropdowns
                const fc = document.getElementById('filter-category');
                if (fc) {
                    const currentVal = fc.value;
                    fc.innerHTML = '<option value="">All Categories</option>';
                    allCategories.forEach(c => fc.add(new Option(c.name, c.name)));
                    fc.value = currentVal;
                }

                // If on Categories page, reload it
                if (document.getElementById('page-categories').classList.contains('active')) {
                    loadCategoriesPage();
                }
            } catch (err) {
                showToast(err.message || 'Error saving category', 'danger');
            }
        }

        async function addRule() {
            await api('/api/categories/rules', 'POST', { pattern: document.getElementById('rule-pattern').value, category: document.getElementById('rule-category').value, priority: parseInt(document.getElementById('rule-priority').value) || 50, is_personal: document.getElementById('rule-personal').checked ? 1 : 0, is_business: document.getElementById('rule-business').checked ? 1 : 0, is_transfer: document.getElementById('rule-transfer-flag').checked ? 1 : 0 });
            bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide(); loadCategoriesPage(); toast('Rule added');
        }

        function showAddTaxonomyModal() {
            document.getElementById('tax-name').value = '';
            document.getElementById('tax-desc').value = '';
            document.getElementById('tax-category-type').value = 'risk';
            document.getElementById('tax-severity').value = 'medium';
            new bootstrap.Modal(document.getElementById('addTaxonomyModal')).show();
        }

        async function addTaxonomy() {
            const data = {
                name: document.getElementById('tax-name').value,
                description: document.getElementById('tax-desc').value,
                category_type: document.getElementById('tax-category-type').value,
                severity: document.getElementById('tax-severity').value
            };
            if (!data.name) return toast('Name is required');
            await api('/api/taxonomy', 'POST', data);
            bootstrap.Modal.getInstance(document.getElementById('addTaxonomyModal')).hide();
            loadCategoriesPage();
            toast('Taxonomy added');
        }

        async function deleteTaxonomy(id) {
            if (!confirm('Are you sure you want to delete this taxonomy definition?')) return;
            await api('/api/taxonomy/' + id, 'DELETE');
            loadCategoriesPage();
            toast('Taxonomy deleted');
        }

        // ===== RECIPIENT ANALYSIS =====
        let recipientData = [];

        async function loadRecipients(filters) {
            if (!filters) filters = FilterStore.getState();
            const safeFilters = { ...filters };
            delete safeFilters.trans_type; // Recipients always uses outflows
            const qs = serializeFilters(safeFilters);
            recipientData = await api('/api/analysis/recipients?' + qs);
            renderRecipients();
        }

        function renderRecipients() {
            const sortBy = document.getElementById('recipient-sort')?.value || 'total';
            let sorted = [...recipientData];
            if (sortBy === 'suspicion') sorted.sort((a, b) => b.suspicion_score - a.suspicion_score);
            else if (sortBy === 'count') sorted.sort((a, b) => b.count - a.count);
            else if (sortBy === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
            else sorted.sort((a, b) => b.total - a.total);

            // Summary cards
            const totalOut = sorted.reduce((s, r) => s + r.total, 0);
            const highSuspicion = sorted.filter(r => r.suspicion_score >= 40).length;
            const topRecipient = sorted[0];
            document.getElementById('recipients-summary').innerHTML = `
            <div class="col"><div class="stat-card info"><div class="stat-value">${sorted.length}</div><div class="stat-label">Unique Recipients</div></div></div>
            <div class="col"><div class="stat-card danger"><div class="stat-value">$${fmt(totalOut)}</div><div class="stat-label">Total Outflows</div></div></div>
            <div class="col"><div class="stat-card ${highSuspicion > 0 ? 'danger' : 'success'}"><div class="stat-value">${highSuspicion}</div><div class="stat-label">High Suspicion</div></div></div>
            <div class="col"><div class="stat-card warning"><div class="stat-value">${topRecipient ? esc(topRecipient.name).substring(0, 20) : 'N/A'}</div><div class="stat-label">Top Recipient ${topRecipient ? '$' + fmt(topRecipient.total) : ''}</div></div></div>
        `;

            // Table
            let html = `<table class="table table-dark-custom"><thead><tr>
            <th>Recipient</th><th>Total Paid</th><th>Count</th><th>Avg</th>
            <th>Concentration</th><th>Suspicion</th><th>Flags</th><th>Cardholders</th><th>Methods</th>
        </tr></thead><tbody>`;

            sorted.forEach(r => {
                const scoreClass = r.suspicion_score >= 40 ? 'suspicion-high' : r.suspicion_score >= 20 ? 'suspicion-med' : 'suspicion-low';
                const riskClass = r.suspicion_score >= 40 ? 'risk-high' : r.suspicion_score >= 20 ? 'risk-medium' : 'risk-low';
                html += `<tr class="clickable-row" onclick="drillToTransactions({search:'${esc(r.name.split(' - ').pop().substring(0, 15))}'})">
                <td><strong>${esc(r.name)}</strong><br><span class="text-muted" style="font-size:0.7rem;">${r.first_date} to ${r.last_date}</span></td>
                <td class="amount-negative fw-bold">$${fmt(r.total)}</td>
                <td>${r.count}</td>
                <td class="amount-negative">$${fmt(r.avg_amount)}</td>
                <td>${r.concentration_pct}%</td>
                <td><div class="d-flex align-items-center gap-2"><div class="suspicion-bar ${scoreClass}"><div class="suspicion-fill" style="width:${r.suspicion_score}%"></div></div><span class="risk-badge ${riskClass}">${r.suspicion_score}</span></div></td>
                <td style="max-width:200px;font-size:0.72rem;">${r.flags.map(f => `<div class="text-warning">${esc(f)}</div>`).join('')}</td>
                <td style="font-size:0.72rem;">${r.cardholders.join(', ')}</td>
                <td style="font-size:0.72rem;">${r.methods.join(', ')}</td>
            </tr>`;
            });

            if (!sorted.length) html += '<tr><td colspan="9" class="text-muted text-center py-4">No outflow data found. Upload statements to analyze.</td></tr>';
            html += '</tbody></table>';
            document.getElementById('recipients-table').innerHTML = html;
        }

        // ===== DEPOSIT AGING =====
        let agingData = [];

        async function loadDepositAging(filters) {
            if (!filters) filters = FilterStore.getState();
            const safeFilters = { ...filters };
            delete safeFilters.trans_type; // Aging always searches for deposits
            delete safeFilters.category; // Categories usually mask deposits
            const qs = serializeFilters(safeFilters);
            agingData = await api('/api/analysis/deposit-aging?' + qs);
            renderDepositAging();
        }

        function renderDepositAging() {
            const filter = document.getElementById('aging-filter')?.value || 'all';
            let filtered = agingData;
            if (filter === 'high') filtered = agingData.filter(d => d.risk === 'high');
            else if (filter === 'medium') filtered = agingData.filter(d => d.risk === 'high' || d.risk === 'medium');

            // Summary
            const highCount = agingData.filter(d => d.risk === 'high').length;
            const medCount = agingData.filter(d => d.risk === 'medium').length;
            const totalDeposits = agingData.reduce((s, d) => s + d.amount, 0);
            const avg3day = agingData.length ? agingData.reduce((s, d) => s + d.pct_3day, 0) / agingData.length : 0;

            document.getElementById('aging-summary').innerHTML = `
            <div class="col"><div class="stat-card success"><div class="stat-value">${agingData.length}</div><div class="stat-label">Total Deposits</div></div></div>
            <div class="col"><div class="stat-card success"><div class="stat-value">$${fmt(totalDeposits)}</div><div class="stat-label">Total Deposited</div></div></div>
            <div class="col"><div class="stat-card ${highCount > 0 ? 'danger' : 'success'}"><div class="stat-value">${highCount}</div><div class="stat-label">High-Risk Drains</div></div></div>
            <div class="col"><div class="stat-card ${medCount > 0 ? 'warning' : 'success'}"><div class="stat-value">${medCount}</div><div class="stat-label">Medium-Risk Drains</div></div></div>
            <div class="col"><div class="stat-card ${avg3day > 50 ? 'danger' : 'info'}"><div class="stat-value">${avg3day.toFixed(0)}%</div><div class="stat-label">Avg 3-Day Drain</div></div></div>
        `;

            let html = `<table class="table table-dark-custom"><thead><tr>
            <th>Deposit Date</th><th>Description</th><th>Deposit Amt</th>
            <th>Out in 3 Days</th><th>% 3-Day</th><th>Out in 7 Days</th><th>% 7-Day</th>
            <th>Risk</th>
        </tr></thead><tbody>`;

            filtered.forEach(d => {
                const riskClass = d.risk === 'high' ? 'risk-high' : d.risk === 'medium' ? 'risk-medium' : 'risk-low';
                const pct3Class = d.pct_3day > 80 ? 'text-danger fw-bold' : d.pct_3day > 50 ? 'text-warning' : '';
                const pct7Class = d.pct_7day > 80 ? 'text-danger fw-bold' : d.pct_7day > 50 ? 'text-warning' : '';
                html += `<tr class="clickable-row" onclick="drillToTransactions({date_from:'${d.deposit.trans_date}',date_to:'${d.deposit.trans_date}',search:'${esc(d.deposit.description.substring(0, 15))}'})">
                <td style="white-space:nowrap;">${d.deposit.trans_date}</td>
                <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(d.deposit.description)}">${esc(d.deposit.description)}</td>
                <td class="amount-positive fw-bold">$${fmt(d.amount)}</td>
                <td class="amount-negative">$${fmt(d.out_3day)}</td>
                <td class="${pct3Class}">${d.pct_3day}%</td>
                <td class="amount-negative">$${fmt(d.out_7day)}</td>
                <td class="${pct7Class}">${d.pct_7day}%</td>
                <td><span class="risk-badge ${riskClass}">${d.risk}</span></td>
            </tr>`;
            });

            if (!filtered.length) html += '<tr><td colspan="8" class="text-muted text-center py-4">No deposit data found.</td></tr>';
            html += '</tbody></table>';
            document.getElementById('aging-table').innerHTML = html;
        }

        // ===== CARDHOLDER COMPARISON (enhanced) =====
        async function loadCardholders(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            const comparison = await api('/api/analysis/cardholder-comparison?' + qs);
            let html = '<div class="row g-3 mb-3">';

            // Summary cards for each cardholder
            comparison.forEach(ch => {
                const suspicionPct = ch.flagged_count > 0 ? Math.min(100, Math.round(ch.flagged_count / ch.total_transactions * 100)) : 0;

                let displayName = ch.cardholder_name;
                if (ch.card_last_four) {
                    displayName += ` (*${ch.card_last_four})`;
                }

                let drillParams = `cardholder:'${esc(ch.cardholder_name)}'`;
                if (ch.card_last_four) {
                    drillParams += `,card_last_four:'${esc(ch.card_last_four)}'`;
                }

                html += `<div class="col-md-6"><div class="card-dark">
                <div class="card-header" style="cursor:pointer;" onclick="drillToTransactions({${drillParams}})">
                    <span><i class="fas fa-user me-1"></i> ${esc(displayName)}</span>
                    <button class="btn btn-sm btn-outline-light py-0" onclick="event.stopPropagation();drillToTransactions({${drillParams}})"><i class="fas fa-external-link-alt fa-xs"></i></button>
                </div>
                <div class="p-3">
                    <div class="row g-2 mb-3">
                        <div class="col-4"><div class="text-center"><div class="amount-negative fw-bold" style="font-size:1.1rem;">$${fmt(ch.total_spent)}</div><div style="color:#8b949e;font-size:0.7rem;">TOTAL SPENT</div></div></div>
                        <div class="col-4"><div class="text-center"><div class="amount-positive fw-bold" style="font-size:1.1rem;">$${fmt(ch.total_received)}</div><div style="color:#8b949e;font-size:0.7rem;">RECEIVED</div></div></div>
                        <div class="col-4"><div class="text-center"><div class="amount-negative fw-bold" style="font-size:1.1rem;">$${fmt(ch.transfers_out)}</div><div style="color:#8b949e;font-size:0.7rem;">TRANSFERS OUT</div></div></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><div class="text-center"><div class="fw-bold" style="color:#c9d1d9;">${ch.total_transactions}</div><div style="color:#8b949e;font-size:0.7rem;">TRANSACTIONS</div></div></div>
                        <div class="col-3"><div class="text-center"><div class="fw-bold" style="color:#c9d1d9;">$${fmt(ch.avg_purchase)}</div><div style="color:#8b949e;font-size:0.7rem;">AVG PURCHASE</div></div></div>
                        <div class="col-3"><div class="text-center"><div class="${ch.flagged_count > 0 ? 'text-danger' : ''} fw-bold" style="color:#c9d1d9;">${ch.flagged_count}</div><div style="color:#8b949e;font-size:0.7rem;">FLAGGED</div></div></div>
                        <div class="col-3"><div class="text-center"><div class="small" style="color:#8b949e;">${ch.first_transaction || 'N/A'}<br>to ${ch.last_transaction || 'N/A'}</div></div></div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><div class="d-flex align-items-center gap-2"><span class="badge badge-personal">Personal</span> <span class="amount-negative">$${fmt(ch.personal_total)}</span></div></div>
                        <div class="col-6"><div class="d-flex align-items-center gap-2"><span class="badge badge-business">Business</span> <span class="amount-negative">$${fmt(ch.business_total)}</span></div></div>
                    </div>
                    <div class="mt-2"><strong class="small" style="color:#8b949e;">Top Categories:</strong></div>
                    <table class="table table-dark-custom mt-1"><tbody>`;
                (ch.top_categories || []).forEach(c => {
                    const barW = ch.total_spent > 0 ? Math.round(c.total / ch.total_spent * 100) : 0;
                    html += `<tr class="clickable-row" onclick="drillToTransactions({${drillParams},category:'${esc(c.category)}'})">
                    <td style="width:35%">${esc(c.category)}</td>
                    <td class="amount-negative">$${fmt(c.total)}</td>
                    <td>${c.cnt}</td>
                    <td><div class="mini-bar" style="background:#f85149;width:${barW}%;">&nbsp;</div></td>
                </tr>`;
                });
                html += `</tbody></table></div></div></div>`;
            });

            html += '</div>';
            if (!comparison.length) html = '<p class="text-muted">No cardholder data. Upload statements to see comparisons.</p>';
            document.getElementById('cardholders-content').innerHTML = html;
        }

        // ===== INTEGRATIONS (OAUTH) =====
        async function loadIntegrations() {
            const renderTiles = (connectedList, userRole = 'USER') => {
                const envFlags = {
                    google: "{{ 'true' if enable_google else 'false' }}" === "true",
                    qb: "{{ 'true' if enable_qb else 'false' }}" === "true"
                };

                const providers = [];
                if (envFlags.google) {
                    providers.push({ id: 'google_drive', name: 'Google Drive', icon: 'fab fa-google-drive', color: '#1fa463', desc: 'Import statements directly from a Google account.' });
                    providers.push({ id: 'google_calendar', name: 'Google Calendar', icon: 'far fa-calendar-alt', color: '#4285F4', desc: 'Correlate transaction dates with scheduled events.' });
                    providers.push({ id: 'gmail', name: 'Gmail', icon: 'far fa-envelope', color: '#EA4335', desc: 'Scan inbox for digitized receipts and invoices.' });
                }
                if (envFlags.qb) {
                    providers.push({ id: 'quickbooks', name: 'QuickBooks', icon: 'fas fa-file-invoice-dollar', color: '#2ca01c', desc: 'Sync chart of accounts and automatically categorize expenses.' });
                }

                let html = '';
                providers.forEach(p => {
                    const isConnected = connectedList.find(c => c.provider === p.id && c.status === 'Connected');
                    const isWorkspace = (p.id === 'quickbooks');
                    const canManage = !isWorkspace || ['ADMIN', 'SUPER_ADMIN'].includes(userRole);
                    html += `
                    <div class="col-md-6 mb-3">
                        <div class="stat-card d-flex align-items-start gap-3">
                            <div class="alert-icon" style="background: rgba(255,255,255,0.1); color: ${p.color}; font-size: 1.5rem; width: 48px; height: 48px;">
                                <i class="${p.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${p.name}</h6>
                                <p class="text-muted small mb-2">${p.desc}</p>
                                ${isConnected ?
                            `<div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-success"><i class="fas fa-check"></i> Connected</span>
                                ${canManage ? `
                                <div>
                                    ${p.id === 'google_drive' ? `<button class="btn btn-sm btn-outline-info py-0 px-2 me-2" onclick="testGoogleIntegration()">Test Connection</button>` : ''}
                                    ${p.id === 'quickbooks' ? `<button class="btn btn-sm btn-outline-info py-0 px-2 me-2" onclick="testQuickBooksIntegration()">Test Connection</button>` : ''}
                                    <button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="disconnectIntegration('${p.id}')">Disconnect</button>
                                </div>
                                ` : ''}
                             </div>` :
                            `<div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">Not connected</span>
                                ${canManage ?
                                `<button class="btn btn-sm btn-outline-light py-0 px-2" onclick="connectIntegration('${p.id}')"><i class="fas fa-link me-1"></i>Connect</button>` :
                                `<span class="badge bg-warning text-dark px-2 py-1"><i class="fas fa-lock me-1"></i>Admin setup required</span>`
                            }
                             </div>`
                        }
                            </div>
                        </div>
                    </div>`;
                });

                document.getElementById('integrations-list').innerHTML = html;
            };

            try {
                const res = await api('/api/integrations/status');
                const connected = res.integrations || [];
                renderTiles(connected, res.role || 'USER');
            } catch (err) {
                console.warn("Integrations endpoint missing or disabled, gracefully falling back to Not connected", err);
                renderTiles([]);
            }
        }

        async function connectIntegration(provider) {
            try {
                toast(`Starting ${provider} connection...`, 'info');
                // Use the dedicated google endpoint if applicable, otherwise fallback
                let endpoint = `/api/integrations/${provider}/connect`;
                if (['google_drive', 'google_calendar', 'gmail'].includes(provider)) {
                    endpoint = '/api/integrations/google/connect';
                }
                const res = await api(endpoint, 'POST');
                if (res && res.authorization_url) {
                    window.location.href = res.authorization_url;
                }
            } catch (err) {
                toast(`Integration ${provider} is not configured on this environment.`, 'danger');
            }
        }

        async function testGoogleIntegration() {
            try {
                toast(`Testing Google connection...`, 'info');
                const res = await api('/api/integrations/google/test', 'POST');
                if (res && res.test_results) {
                    let msg = "";
                    for (const [service, result] of Object.entries(res.test_results)) {
                        msg += `${service}: ${result.message}\n`;
                    }
                    toast(`Test Results:\n${msg}`, 'success');
                }
            } catch (err) {
                toast(`Test failed: ${err.message}`, 'danger');
            }
        }

        async function testQuickBooksIntegration() {
            try {
                toast(`Testing QuickBooks connection...`, 'info');
                const res = await api('/api/integrations/quickbooks/test', 'POST');
                if (res && res.test_results) {
                    let msg = "";
                    for (const [service, result] of Object.entries(res.test_results)) {
                        msg += `${service}: ${result.message}\n`;
                    }
                    toast(`Test Results:\n${msg}`, 'success');
                }
            } catch (err) {
                toast(`Test failed: ${err.message}`, 'danger');
            }
        }

        async function disconnectIntegration(provider) {
            if (!confirm(`Are you sure you want to disconnect ${provider}?`)) return;
            try {
                await api(`/api/integrations/${provider}/disconnect`, 'POST');
                toast(`Disconnected ${provider} successfully`, 'success');
                loadIntegrations();
            } catch (err) {
                toast(`Failed to disconnect ${provider}`, 'danger');
            }
        }

        // ===== AUDIT TRAIL =====
        async function loadAuditTrail() {
            const trail = await api('/api/audit-trail');
            let html = `<table class="table table-dark-custom"><thead><tr>
            <th>Timestamp</th><th>Action</th><th>Field</th><th>Old Value</th><th>New Value</th><th>Transaction</th>
        </tr></thead><tbody>`;

            trail.forEach(entry => {
                const actionClass = entry.action === 'DELETE' ? 'text-danger' : entry.action === 'UPDATE' ? 'text-warning' : 'text-info';
                html += `<tr>
                <td style="white-space:nowrap;font-size:0.75rem;">${(entry.timestamp || '').substring(0, 19)}</td>
                <td><span class="${actionClass} fw-bold">${entry.action || ''}</span></td>
                <td style="font-size:0.8rem;">${esc(entry.field_changed || '')}</td>
                <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;font-size:0.75rem;" title="${esc(entry.old_value || '')}">${esc(entry.old_value || '-')}</td>
                <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;font-size:0.75rem;" title="${esc(entry.new_value || '')}">${esc(entry.new_value || '-')}</td>
                <td style="font-size:0.75rem;">${entry.trans_description ? esc(entry.trans_description).substring(0, 30) + (entry.trans_amount ? ' ($' + fmt(Math.abs(entry.trans_amount)) + ')' : '') : '#' + (entry.transaction_id || '?')}</td>
            </tr>`;
            });

            if (!trail.length) html += '<tr><td colspan="6" class="text-muted text-center py-4">No audit trail entries yet. Edit or delete transactions to see changes logged here.</td></tr>';
            html += '</tbody></table>';
            document.getElementById('audit-trail-table').innerHTML = html;
        }

        // ===== EXECUTIVE SUMMARY =====
        async function loadExecutiveSummary(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            const summary = await api('/api/analysis/summary?' + qs);
            const el = document.getElementById('executive-summary');
            if (!summary || summary.total_analyzed === 0) { el.style.display = 'none'; return; }
            el.style.display = 'block';

            // Risk gauge
            const riskColor = summary.risk_score >= 60 ? '#f85149' : summary.risk_score >= 30 ? '#d29922' : '#3fb950';
            const riskLabel = summary.risk_score >= 60 ? 'HIGH RISK' : summary.risk_score >= 30 ? 'MEDIUM RISK' : 'LOW RISK';
            document.getElementById('risk-gauge-wrap').innerHTML = `
            <span class="small text-muted">${summary.total_analyzed} transactions | ${summary.date_range}</span>
            <div style="width:100px;"><div class="risk-gauge"><div class="risk-gauge-fill" style="width:${summary.risk_score}%;background:${riskColor};"></div></div></div>
            <span class="risk-badge" style="background:${riskColor}20;color:${riskColor};">${riskLabel} ${summary.risk_score}</span>
        `;

            // Findings
            let html = '<div class="row g-2">';
            summary.findings.forEach(f => {
                html += `<div class="col-md-6"><div class="finding-card ${f.severity}">
                <div class="finding-title"><i class="fas fa-${f.severity === 'danger' ? 'exclamation-triangle text-danger' : f.severity === 'warning' ? 'exclamation-circle text-warning' : 'info-circle text-info'} me-1"></i>${esc(f.title)}</div>
                <div class="finding-detail">${esc(f.detail)}</div>
            </div></div>`;
            });
            html += '</div>';
            document.getElementById('exec-findings').innerHTML = html;
        }

        // ===== MONEY FLOW =====
        let moneyFlowData = null;

        async function loadMoneyFlow(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            moneyFlowData = await api('/api/analysis/money-flow?' + qs);
            const d = moneyFlowData;

            // Summary
            const totalIn = d.accounts.reduce((s, a) => s + a.inflow, 0);
            const totalOut = d.accounts.reduce((s, a) => s + a.outflow, 0);
            const totalXfer = d.flows.reduce((s, f) => s + f.total, 0);
            document.getElementById('money-flow-summary').innerHTML = `
            <div class="col"><div class="stat-card success"><div class="stat-value">$${fmt(totalIn)}</div><div class="stat-label">Total Inflows</div></div></div>
            <div class="col"><div class="stat-card danger"><div class="stat-value">$${fmt(totalOut)}</div><div class="stat-label">Total Outflows</div></div></div>
            <div class="col"><div class="stat-card warning"><div class="stat-value">$${fmt(totalXfer)}</div><div class="stat-label">Cross-Account Transfers</div></div></div>
            <div class="col"><div class="stat-card info"><div class="stat-value">${d.accounts.length}</div><div class="stat-label">Accounts</div></div></div>
            <div class="col"><div class="stat-card purple"><div class="stat-value">${d.methods.length}</div><div class="stat-label">Payment Methods</div></div></div>
        `;

            // Account flows table
            let acctHtml = '<table class="table table-dark-custom"><thead><tr><th>Account</th><th>Type</th><th>In</th><th>Out</th><th>Net</th><th>Flow</th></tr></thead><tbody>';
            const maxFlow = Math.max(...d.accounts.map(a => Math.max(a.inflow, a.outflow)), 1);
            d.accounts.forEach(a => {
                const net = a.inflow - a.outflow;
                const inW = Math.round(a.inflow / maxFlow * 120);
                const outW = Math.round(a.outflow / maxFlow * 120);
                acctHtml += `<tr class="clickable-row" onclick="drillToTransactions({account_id:'${a.account_id}'})">
                <td><strong>${esc(a.account_name || 'Unknown')}</strong><br><span class="text-muted" style="font-size:0.7rem;">${esc(a.institution || '')}</span></td>
                <td><span class="badge badge-${a.account_type === 'bank' ? 'deposit' : a.account_type === 'credit_card' ? 'transfer' : 'venmo'}">${a.account_type || 'unknown'}</span></td>
                <td class="amount-positive">$${fmt(a.inflow)}</td>
                <td class="amount-negative">$${fmt(a.outflow)}</td>
                <td class="${net < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(net))}</td>
                <td><div style="display:flex;gap:1px;"><div style="background:#3fb950;height:10px;width:${inW}px;border-radius:2px;"></div><div style="background:#f85149;height:10px;width:${outW}px;border-radius:2px;"></div></div></td>
            </tr>`;
            });
            if (!d.accounts.length) acctHtml += '<tr><td colspan="6" class="text-muted text-center py-3">No account data.</td></tr>';
            acctHtml += '</tbody></table>';
            document.getElementById('flow-accounts').innerHTML = acctHtml;

            // Transfer destinations
            let xferHtml = '<table class="table table-dark-custom"><thead><tr><th>Destination</th><th>Total</th><th>Count</th><th>Period</th></tr></thead><tbody>';
            d.flows.forEach(f => {
                xferHtml += `<tr class="clickable-row" onclick="drillToTransactions({search:'${esc(f.destination)}', is_transfer: 1})">
                <td><i class="fas fa-arrow-right text-warning me-1"></i>${esc(f.destination)}</td>
                <td class="amount-negative fw-bold">$${fmt(f.total)}</td>
                <td>${f.count}</td>
                <td style="font-size:0.72rem;">${f.first_date || ''} to ${f.last_date || ''}</td>
            </tr>`;
            });
            if (!d.flows.length) xferHtml += '<tr><td colspan="4" class="text-muted text-center py-3">No cross-account transfers detected.</td></tr>';
            xferHtml += '</tbody></table>';
            document.getElementById('flow-transfers').innerHTML = xferHtml;

            // Payment methods
            let methHtml = '<table class="table table-dark-custom"><thead><tr><th>Method</th><th>Total</th><th>Count</th><th>Share</th></tr></thead><tbody>';
            d.methods.forEach(m => {
                const pct = totalOut > 0 ? (m.total / totalOut * 100).toFixed(1) : 0;
                const barW = totalOut > 0 ? Math.round(m.total / totalOut * 200) : 0;
                methHtml += `<tr class="clickable-row" onclick="drillToTransactions({payment_method:'${esc(m.payment_method)}'})">
                <td><strong>${esc(m.payment_method)}</strong></td>
                <td class="amount-negative">$${fmt(m.total)}</td>
                <td>${m.cnt}</td>
                <td><div style="display:flex;align-items:center;gap:6px;"><div style="background:#58a6ff;height:10px;width:${barW}px;border-radius:2px;"></div><span class="text-muted small">${pct}%</span></div></td>
            </tr>`;
            });
            if (!d.methods.length) methHtml += '<tr><td colspan="4" class="text-muted text-center py-3">No payment method data.</td></tr>';
            methHtml += '</tbody></table>';
            document.getElementById('flow-methods').innerHTML = methHtml;
        }

        // ===== TIMELINE =====
        let timelineData = [];

        async function loadTimeline(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            timelineData = await api('/api/analysis/timeline?' + qs);
            renderTimeline();
        }

        function renderTimeline() {
            if (!timelineData.length) {
                document.getElementById('timeline-chart').innerHTML = '<p class="text-muted text-center py-4">No timeline data. Upload statements to see the timeline.</p>';
                document.getElementById('timeline-summary').innerHTML = '';
                return;
            }

            const maxAmt = Math.max(...timelineData.map(d => Math.max(d.day_in, d.day_out)));
            const maxBar = 300;
            const totalDays = timelineData.length;
            const totalIn = timelineData.reduce((s, d) => s + d.day_in, 0);
            const totalOut = timelineData.reduce((s, d) => s + d.day_out, 0);
            const peakDay = timelineData.reduce((p, d) => d.day_out > (p.day_out || 0) ? d : p, {});
            const minBal = Math.min(...timelineData.map(d => d.running_balance));
            const maxBal = Math.max(...timelineData.map(d => d.running_balance));

            document.getElementById('timeline-summary').innerHTML = `
            <div class="col"><div class="stat-card info"><div class="stat-value">${totalDays}</div><div class="stat-label">Days with Activity</div></div></div>
            <div class="col"><div class="stat-card danger"><div class="stat-value">${peakDay.trans_date || 'N/A'}</div><div class="stat-label">Peak Spending Day ($${fmt(peakDay.day_out || 0)})</div></div></div>
            <div class="col"><div class="stat-card ${minBal < 0 ? 'danger' : 'success'}"><div class="stat-value">$${fmt(Math.abs(minBal))}</div><div class="stat-label">${minBal < 0 ? 'Max Deficit' : 'Min Balance'}</div></div></div>
            <div class="col"><div class="stat-card success"><div class="stat-value">$${fmt(maxBal)}</div><div class="stat-label">Peak Balance</div></div></div>
        `;

            let html = '';
            timelineData.forEach(d => {
                const inW = maxAmt > 0 ? Math.round(d.day_in / maxAmt * maxBar) : 0;
                const outW = maxAmt > 0 ? Math.round(d.day_out / maxAmt * maxBar) : 0;
                const xferW = maxAmt > 0 ? Math.round(d.day_transfers / maxAmt * maxBar) : 0;
                const flagIcon = d.day_flagged > 0 ? `<span class="timeline-flag"><i class="fas fa-flag"></i>${d.day_flagged}</span>` : '';
                const notable = d.notable ? `<span class="text-muted" style="font-size:0.65rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;" title="${esc(d.notable)}">${esc(d.notable).substring(0, 50)}</span>` : '';

                html += `<div class="timeline-row" onclick="drillToTransactions({date_from:'${d.trans_date}',date_to:'${d.trans_date}'})" style="cursor:pointer;">
                <span style="width:80px;flex-shrink:0;font-weight:600;">${d.trans_date.substring(5)}</span>
                <span style="width:25px;flex-shrink:0;text-align:center;color:#8b949e;">${d.day_count}</span>
                <div class="timeline-bar" style="width:${Math.max(inW + outW, 4)}px;">
                    ${inW > 0 ? `<div class="bar-in" style="width:${inW}px;" title="In: $${fmt(d.day_in)}"></div>` : ''}
                    ${outW > 0 ? `<div class="bar-out" style="width:${outW - xferW}px;" title="Out: $${fmt(d.day_out)}"></div>` : ''}
                    ${xferW > 0 ? `<div class="bar-xfer" style="width:${xferW}px;" title="Transfers: $${fmt(d.day_transfers)}"></div>` : ''}
                </div>
                <span style="width:80px;flex-shrink:0;text-align:right;" class="${d.running_balance < 0 ? 'amount-negative' : 'text-muted'}" style="font-size:0.7rem;">$${fmt(Math.abs(d.running_balance))}</span>
                ${flagIcon} ${notable}
            </div>`;
            });
            document.getElementById('timeline-chart').innerHTML = html;
        }

        // ===== PRINT REPORT =====
        function printReport() {
            // Show dashboard and summary, then trigger print
            navigateTo('dashboard');
            setTimeout(() => { window.print(); }, 500);
        }

        // ===== LIVE SEARCH (debounce) =====
        let searchTimer = null;
        const searchInput = document.getElementById('filter-search');
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    const activePage = document.querySelector('.nav-link.active');
                    if (activePage && activePage.dataset.page === 'transactions') loadTransactions();
                }, 400);
            });
        }

        // ===== UTILITIES =====
        async function ensureCategories() {
            if (!allCategories.length) allCategories = await api('/api/categories');
            // Populate filter dropdowns
            const fc = document.getElementById('filter-category');
            if (fc && fc.options.length <= 1) { allCategories.forEach(c => fc.add(new Option(c.name, c.name))); }
        }

        function populateCardholderFilter() {
            const fc = document.getElementById('filter-cardholder');
            if (!fc) return;
            const current = fc.value;

            const groups = {
                'Bank Accounts': new Set(),
                'Credit Card Holders': new Set(),
                'Debit Card Holders': new Set(),
                'Venmo Accounts': new Set(),
                'Other Payment Methods': new Set()
            };

            allTransactions.forEach(t => {
                const h = t.cardholder_name;
                if (!h) return;
                const m = (t.payment_method || '').toLowerCase();

                if (m === 'credit') groups['Credit Card Holders'].add(h);
                else if (m === 'debit') groups['Debit Card Holders'].add(h);
                else if (m === 'venmo') groups['Venmo Accounts'].add(h);
                else if (['check', 'transfer', 'wire', 'cash', 'bank'].includes(m)) groups['Bank Accounts'].add(h);
                else groups['Other Payment Methods'].add(h);
            });

            // Remove overlaps (prioritize more specific types over Bank/Other)
            const seen = new Set();
            for (const g of ['Venmo Accounts', 'Credit Card Holders', 'Debit Card Holders', 'Bank Accounts', 'Other Payment Methods']) {
                const uniqueForGroup = new Set();
                groups[g].forEach(h => {
                    if (!seen.has(h)) {
                        uniqueForGroup.add(h);
                        seen.add(h);
                    }
                });
                groups[g] = [...uniqueForGroup].sort();
            }

            fc.innerHTML = '<option value="">All Cardholders</option>';
            for (const [gLabel, sortedHolders] of Object.entries(groups)) {
                if (sortedHolders.length > 0) {
                    const og = document.createElement('optgroup');
                    og.label = gLabel;
                    sortedHolders.forEach(h => og.appendChild(new Option(h, h)));
                    fc.appendChild(og);
                }
            }
            fc.value = current;
        }

        async function loadCategoryOptions(selectId, includeEmpty) {
            await ensureCategories();
            if (selectId) {
                const sel = document.getElementById(selectId);
                if (sel) { sel.innerHTML = (includeEmpty ? '<option value="">-- No Change --</option>' : '') + allCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); }
            }
        }

        function categoryOptions(selected) {
            let optionsHtml = allCategories.map(c => `<option value="${c.name}" ${c.name === selected ? 'selected' : ''}>${c.name}</option>`).join('');
            if (selected && !allCategories.some(c => c.name === selected)) {
                optionsHtml = `<option value="${selected}" selected>${selected}</option>` + optionsHtml;
            }
            return optionsHtml;
        }
        async function recategorizeAll() { if (!confirm('Re-run auto-categorization?')) return; const r = await api('/api/recategorize', 'POST'); toast(`Updated ${r.updated} transactions`); loadDashboard(); }
        function exportCSV() { window.open('/api/export/csv', '_blank'); }
        async function clearAllData() {
            if (!confirm('WARNING: This will permanently delete ALL transactions, documents, accounts, and uploaded files. Categories and rules will be kept.\n\nAre you sure?')) return;
            if (!confirm('FINAL CONFIRMATION: Delete all financial data?')) return;
            await api('/api/clear-data', 'POST');
            toast('All data cleared');
            loadDashboard();
        }

        async function api(url, method = 'GET', body = null) {
            const opts = { method, headers: {} };
            if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
            try {
                const r = await fetch(url, opts);
                if (r.status === 401 || r.status === 403) {
                    const nextUrl = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
                    window.location.href = '/login?next=' + nextUrl;
                    return new Promise(() => { }); // Halt execution to prevent UI flashing before navigation completes
                }
                return await r.json();
            } catch (e) { toast('Error: ' + e.message); return []; }
        }

        function fmt(n) { return (n || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function toast(msg) { const c = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'alert alert-info small py-2 px-3 mb-2'; el.style.cssText = 'min-width:200px;'; el.innerHTML = `<i class="fas fa-check-circle me-1"></i> ${esc(msg)}`; c.appendChild(el); setTimeout(() => el.remove(), 3000); }

        // ===== MOBILE SIDEBAR TOGGLE =====
        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('open');
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;
            sidebar.classList.toggle('open', shouldOpen);
            overlay.classList.toggle('open', shouldOpen);
        }

        // ===== GLOBAL SEARCH =====
        let globalSearchTimer = null;
        async function globalSearch(query) {
            const resultsEl = document.getElementById('global-results');
            clearTimeout(globalSearchTimer);
            if (!query || query.length < 2) { resultsEl.classList.remove('show'); return; }
            globalSearchTimer = setTimeout(async () => {
                const data = await api('/api/search/global?q=' + encodeURIComponent(query));
                let html = '';
                if (data.transactions && data.transactions.length) {
                    html += '<div class="global-result-section">Transactions</div>';
                    data.transactions.forEach(t => {
                        html += `<div class="global-result-item" onclick="navigateTo('transactions',{search:'${esc(query)}'});document.getElementById('global-results').classList.remove('show');document.getElementById('global-search').value='';">
                        <div>${esc(t.description)}</div>
                        <div class="text-muted" style="font-size:0.7rem;">${t.trans_date} | $${fmt(Math.abs(t.amount))} | ${t.category}</div>
                    </div>`;
                    });
                }
                if (data.notes && data.notes.length) {
                    html += '<div class="global-result-section">Case Notes</div>';
                    data.notes.forEach(n => {
                        html += `<div class="global-result-item" onclick="navigateTo('case-notes');document.getElementById('global-results').classList.remove('show');document.getElementById('global-search').value='';">
                        <div>${esc(n.title)}</div>
                        <div class="text-muted" style="font-size:0.7rem;">${n.note_type} | ${n.severity}</div>
                    </div>`;
                    });
                }
                if (data.documents && data.documents.length) {
                    html += '<div class="global-result-section">Documents</div>';
                    data.documents.forEach(d => {
                        html += `<div class="global-result-item" onclick="navigateTo('documents');document.getElementById('global-results').classList.remove('show');document.getElementById('global-search').value='';">
                        <div>${esc(d.filename)}</div>
                        <div class="text-muted" style="font-size:0.7rem;">${d.doc_category || ''}</div>
                    </div>`;
                    });
                }
                if (!html) html = '<div class="global-result-item text-muted">No results found</div>';
                resultsEl.innerHTML = html;
                resultsEl.classList.add('show');
            }, 300);
        }
        // Close global search on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.global-search-wrap')) {
                document.getElementById('global-results').classList.remove('show');
            }
        });

        // ===== ALERTS =====
        async function loadAlerts() {
            const alerts = await api('/api/alerts');
            updateAlertBadge(alerts);

            const totalItems = alerts.reduce((s, a) => s + a.count, 0);
            const dangerCount = alerts.filter(a => a.severity === 'danger').length;
            document.getElementById('alerts-summary').innerHTML = `
            <div class="col"><div class="stat-card ${dangerCount > 0 ? 'danger' : 'info'}"><div class="stat-value">${alerts.length}</div><div class="stat-label">Active Alerts</div></div></div>
            <div class="col"><div class="stat-card warning"><div class="stat-value">${totalItems}</div><div class="stat-label">Items Needing Attention</div></div></div>
            <div class="col"><div class="stat-card ${dangerCount > 0 ? 'danger' : 'success'}"><div class="stat-value">${dangerCount}</div><div class="stat-label">Critical Alerts</div></div></div>
        `;

            if (!alerts.length) {
                document.getElementById('alerts-list').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-check-circle fa-2x mb-2 text-success"></i><br>All clear! No items need attention.</div>';
                return;
            }

            let html = '';
            alerts.forEach(a => {
                const icon = a.type === 'uncategorized' ? 'question-circle' : a.type === 'flagged_unreviewed' ? 'flag' : a.type === 'no_cardholder' ? 'user-slash' : a.type === 'unclassified' ? 'tags' : 'dollar-sign';
                html += `<div class="alert-item" onclick="navigateTo('${a.action}', ${JSON.stringify(a.filters).replace(/"/g, '&quot;')})">
                <div class="alert-icon ${a.severity}"><i class="fas fa-${icon}"></i></div>
                <div class="flex-grow-1">
                    <div class="fw-bold" style="font-size:0.85rem;">${esc(a.title)}</div>
                    <div class="text-muted" style="font-size:0.75rem;">${esc(a.detail)}</div>
                </div>
                <div class="alert-count ${a.severity === 'danger' ? 'text-danger' : a.severity === 'warning' ? 'text-warning' : 'text-info'}">${a.count}</div>
                <i class="fas fa-chevron-right text-muted"></i>
            </div>`;
            });
            document.getElementById('alerts-list').innerHTML = html;
        }

        function updateAlertBadge(alerts) {
            const badge = document.getElementById('alert-badge');
            if (!alerts) { api('/api/alerts').then(a => updateAlertBadge(a)); return; }
            const total = alerts.reduce((s, a) => s + a.count, 0);
            if (total > 0) { badge.textContent = total; badge.style.display = ''; }
            else { badge.style.display = 'none'; }
        }

        // ===== CASE NOTES =====
        let caseNotesData = [];
        let editingNoteId = null;

        async function loadCaseNotes() {
            caseNotesData = await api('/api/case-notes');
            renderCaseNotes();
        }

        function renderCaseNotes() {
            const filter = document.getElementById('note-filter')?.value || 'all';
            let filtered = caseNotesData;
            if (filter !== 'all') filtered = caseNotesData.filter(n => n.note_type === filter);

            if (!filtered.length) {
                document.getElementById('case-notes-list').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-sticky-note fa-2x mb-2"></i><br>No case notes yet. Click "Add Note" to start documenting your investigation.</div>';
                return;
            }

            let html = '';
            filtered.forEach(n => {
                const sevIcon = n.severity === 'danger' ? 'exclamation-triangle text-danger' : n.severity === 'warning' ? 'exclamation-circle text-warning' : 'info-circle text-info';
                const typeLabel = n.note_type.charAt(0).toUpperCase() + n.note_type.slice(1);
                html += `<div class="note-card ${n.note_type}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="note-title"><i class="fas fa-${sevIcon} me-1"></i> ${esc(n.title)}</div>
                    <div>
                        <span class="badge bg-secondary me-1">${typeLabel}</span>
                        <button class="btn btn-sm btn-outline-light py-0 px-1" onclick="editNote(${n.id})" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteNote(${n.id})" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                    </div>
                </div>
                <div class="note-body">${esc(n.content)}</div>
                <div class="note-meta"><i class="fas fa-clock me-1"></i> Created: ${(n.created_at || '').substring(0, 16)} | Updated: ${(n.updated_at || '').substring(0, 16)}</div>
            </div>`;
            });
            document.getElementById('case-notes-list').innerHTML = html;
        }

        function showAddNoteModal() {
            editingNoteId = null;
            document.getElementById('noteModalTitle').innerHTML = '<i class="fas fa-sticky-note"></i> Add Note';
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('note-type').value = 'general';
            document.getElementById('note-severity').value = 'info';
            new bootstrap.Modal(document.getElementById('noteModal')).show();
        }

        function editNote(id) {
            const note = caseNotesData.find(n => n.id === id);
            if (!note) return;
            editingNoteId = id;
            document.getElementById('noteModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Note';
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-content').value = note.content;
            document.getElementById('note-type').value = note.note_type || 'general';
            document.getElementById('note-severity').value = note.severity || 'info';
            new bootstrap.Modal(document.getElementById('noteModal')).show();
        }

        async function saveNote() {
            const data = {
                title: document.getElementById('note-title').value,
                content: document.getElementById('note-content').value,
                note_type: document.getElementById('note-type').value,
                severity: document.getElementById('note-severity').value,
            };
            if (!data.title || !data.content) { toast('Title and content required'); return; }
            if (editingNoteId) {
                await api(`/api/case-notes/${editingNoteId}`, 'PUT', data);
                toast('Note updated');
            } else {
                await api('/api/case-notes', 'POST', data);
                toast('Note added');
            }
            bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            loadCaseNotes();
        }

        async function deleteNote(id) {
            if (!confirm('Delete this note?')) return;
            await api(`/api/case-notes/${id}`, 'DELETE');
            toast('Note deleted');
            loadCaseNotes();
        }

        // ===== SAVED FILTERS =====
        async function saveCurrentFilter() {
            const name = prompt('Name this filter:');
            if (!name) return;
            const filters = FilterStore.getState();
            // Remove view_mode from saved filter as it is a toggle
            delete filters.view_mode;
            await api('/api/saved-filters', 'POST', { name, filters });
            toast('Filter saved');
            loadSavedFilters();
        }

        async function loadSavedFilters() {
            const filters = await api('/api/saved-filters');
            const bar = document.getElementById('saved-filters-bar');
            if (!filters.length) { bar.style.display = 'none'; return; }
            bar.style.display = 'block';
            let html = '<span class="text-muted small me-2"><i class="fas fa-bookmark me-1"></i>Saved:</span>';
            filters.forEach(f => {
                html += `<span class="saved-filter-chip" onclick="applySavedFilter(${f.id})">
                ${esc(f.name)}
                <span class="del" onclick="event.stopPropagation();deleteSavedFilter(${f.id})">&times;</span>
            </span>`;
            });
            bar.innerHTML = html;
        }

        async function applySavedFilter(id) {
            const filters = await api('/api/saved-filters');
            const f = filters.find(x => x.id === id);
            if (!f) return;
            const parsed = typeof f.filters === 'string' ? JSON.parse(f.filters) : f.filters;
            drillToTransactions(parsed);
        }

        async function deleteSavedFilter(id) {
            await api(`/api/saved-filters/${id}`, 'DELETE');
            toast('Filter deleted');
            loadSavedFilters();
        }

        // ===== PAGINATION =====
        function updatePagination(total) {
            const controls = document.getElementById('pagination-controls');
            if (total <= perPage) {
                controls.style.display = 'none';
                return;
            }
            controls.style.display = '';
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages} (${total} total)`;
            document.getElementById('page-first').disabled = currentPage <= 1;
            document.getElementById('page-prev').disabled = currentPage <= 1;
            document.getElementById('page-next').disabled = currentPage >= totalPages;
            document.getElementById('page-last').disabled = currentPage >= totalPages;
        }

        function goToPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            currentPage = page;
            loadTransactions();
        }

        function changePerPage(val) {
            perPage = parseInt(val);
            currentPage = 1;
            loadTransactions();
        }

        // ===== EXPORT PDF REPORT =====
        function exportPDFReport() {
            toast('Generating PDF report...');
            window.open('/api/export/report', '_blank');
        }

        // ===== RECURRING TRANSACTIONS =====
        async function loadRecurring(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            recurringData = await api('/api/analysis/recurring?' + qs);
            renderRecurring();
        }

        function renderRecurring() {
            const filter = document.getElementById('recurring-filter')?.value || 'all';
            let filtered = recurringData;
            if (filter !== 'all') filtered = recurringData.filter(r => r.frequency === filter);

            // Summary
            const totalRecurring = recurringData.reduce((s, r) => s + r.total_amount, 0);
            const withFlags = recurringData.filter(r => r.flags.length > 0).length;
            document.getElementById('recurring-summary').innerHTML = `
            <div class="col"><div class="stat-card info"><div class="stat-value">${recurringData.length}</div><div class="stat-label">Recurring Patterns</div></div></div>
            <div class="col"><div class="stat-card danger"><div class="stat-value">$${fmt(totalRecurring)}</div><div class="stat-label">Total Recurring Spend</div></div></div>
            <div class="col"><div class="stat-card ${withFlags > 0 ? 'warning' : 'success'}"><div class="stat-value">${withFlags}</div><div class="stat-label">Patterns with Flags</div></div></div>
        `;

            if (!filtered.length) {
                document.getElementById('recurring-table').innerHTML = '<div class="text-center text-muted py-4">No recurring patterns detected.</div>';
                return;
            }

            let html = `<table class="table table-dark-custom"><thead><tr>
            <th>Description</th><th>Frequency</th><th>Count</th><th>Avg Amount</th><th>Total</th>
            <th>Amount Consistent</th><th>Period</th><th>Flags</th>
        </tr></thead><tbody>`;

            filtered.forEach(r => {
                const flagHtml = r.flags.map(f => `<div class="text-warning" style="font-size:0.7rem;">${esc(f)}</div>`).join('');
                html += `<tr class="clickable-row" onclick="drillToTransactions({search:'${esc(r.description.substring(0, 20))}'})">
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(r.description)}">${esc(r.description)}</td>
                <td><span class="badge bg-secondary">${r.frequency}</span></td>
                <td>${r.count}</td>
                <td class="amount-negative">$${fmt(r.avg_amount)}</td>
                <td class="amount-negative fw-bold">$${fmt(r.total_amount)}</td>
                <td>${r.amount_consistent ? '<i class="fas fa-check text-success"></i> Yes' : '<i class="fas fa-times text-muted"></i> Varies'}</td>
                <td style="font-size:0.72rem;">${r.first_date} to ${r.last_date}</td>
                <td>${flagHtml || '<span class="text-muted">-</span>'}</td>
            </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('recurring-table').innerHTML = html;
        }

        // ===== CARDHOLDER TIMELINE COMPARISON =====
        async function loadCardholderTimeline(filters) {
            if (!filters) filters = FilterStore.getState();
            const qs = serializeFilters(filters);
            const data = await api('/api/analysis/cardholder-timeline?' + qs);
            renderCardholderTimeline(data);
        }

        function renderCardholderTimeline(data) {
            const cardholders = Object.keys(data);
            if (!cardholders.length) {
                document.getElementById('cardholder-timeline-table').innerHTML = '<div class="text-center text-muted py-4">No cardholder data available.</div>';
                return;
            }

            // Collect all unique months
            const allMonths = new Set();
            cardholders.forEach(ch => data[ch].forEach(d => allMonths.add(d.month)));
            const months = [...allMonths].sort();

            // Chart colors
            const chartColors = ['#f85149', '#58a6ff', '#3fb950', '#d29922', '#bc8cff', '#fd7e14'];

            // Spending overlay chart
            const ctx1 = document.getElementById('cardholder-timeline-chart');
            if (cardholderTimelineChart) cardholderTimelineChart.destroy();
            cardholderTimelineChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: cardholders.map((ch, i) => {
                        const monthMap = {};
                        data[ch].forEach(d => { monthMap[d.month] = d.spent; });
                        return {
                            label: ch,
                            data: months.map(m => monthMap[m] || 0),
                            borderColor: chartColors[i % chartColors.length],
                            backgroundColor: chartColors[i % chartColors.length] + '20',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                        };
                    })
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8b949e' } } },
                    scales: {
                        x: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#8b949e', callback: v => '$' + (v / 1000).toFixed(0) + 'k' }, grid: { color: '#21262d' } }
                    },
                    interaction: { mode: 'index', intersect: false },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            const month = months[idx];
                            // Get which dataset (cardholder) was clicked specifically
                            const datasetIdx = activeEls[0].datasetIndex;
                            const cardholder = cardholders[datasetIdx];

                            const handler = window.createDrilldownHandler({
                                sourceTab: 'analysis',
                                widgetId: 'cardholder-timeline-chart',
                                defaultTarget: DrilldownTarget.TRANSACTIONS,
                                breadcrumbLabel: 'Analysis',
                                breadcrumbStore: window.GlobalBreadcrumbs,
                                getState: () => FilterStore.getState(),
                                onLogEvent: window.logDrilldownEvent,
                                onNavigate: (target, nextFilters) => {
                                    FilterStore.replace(nextFilters);
                                    window.navigateTo(target.toLowerCase());
                                }
                            });

                            handler({ filters: { cardholder: cardholder, date_from: month + '-01', date_to: month + '-31' } });
                        }
                    }
                }
            });

            // Personal vs Business stacked bar
            const ctx2 = document.getElementById('personal-business-chart');
            if (personalBusinessChart) personalBusinessChart.destroy();
            personalBusinessChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: cardholders,
                    datasets: [
                        {
                            label: 'Personal',
                            data: cardholders.map(ch => data[ch].reduce((s, d) => s + d.personal, 0)),
                            backgroundColor: 'rgba(210,153,34,0.7)', borderRadius: 3
                        },
                        {
                            label: 'Business',
                            data: cardholders.map(ch => data[ch].reduce((s, d) => s + (d.spent - d.personal), 0)),
                            backgroundColor: 'rgba(88,166,255,0.7)', borderRadius: 3
                        },
                        {
                            label: 'Transfers',
                            data: cardholders.map(ch => data[ch].reduce((s, d) => s + d.transfers, 0)),
                            backgroundColor: 'rgba(248,81,73,0.7)', borderRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8b949e', font: { size: 10 } } } },
                    scales: {
                        x: { stacked: true, ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                        y: { stacked: true, ticks: { color: '#8b949e', callback: v => '$' + (v / 1000).toFixed(0) + 'k' }, grid: { color: '#21262d' } }
                    },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            const cardholder = cardholders[idx];
                            const datasetIdx = activeEls[0].datasetIndex;
                            const segment = ['is_personal', 'is_business', 'is_transfer'][datasetIdx];

                            const filters = { cardholder: cardholder };
                            if (segment === 'is_personal') filters.is_personal = '1';
                            if (segment === 'is_business') filters.is_business = '1';
                            if (segment === 'is_transfer') filters.is_transfer = '1';

                            const handler = window.createDrilldownHandler({
                                sourceTab: 'analysis',
                                widgetId: 'personal-business-chart',
                                defaultTarget: DrilldownTarget.TRANSACTIONS,
                                breadcrumbLabel: 'Analysis',
                                breadcrumbStore: window.GlobalBreadcrumbs,
                                getState: () => FilterStore.getState(),
                                onLogEvent: window.logDrilldownEvent,
                                onNavigate: (target, nextFilters) => {
                                    FilterStore.replace(nextFilters);
                                    window.navigateTo(target.toLowerCase());
                                }
                            });

                            handler({ filters: filters });
                        }
                    }
                }
            });

            // Detail table
            let tHtml = '<table class="table table-dark-custom"><thead><tr><th>Month</th>';
            cardholders.forEach(ch => { tHtml += `<th>${esc(ch)}</th>`; });
            tHtml += '</tr></thead><tbody>';
            months.forEach(m => {
                tHtml += `<tr><td class="fw-bold">${m}</td>`;
                cardholders.forEach(ch => {
                    const d = data[ch].find(x => x.month === m);
                    tHtml += `<td class="amount-negative" style="cursor:pointer;" onclick="drillToTransactions({cardholder:'${esc(ch)}', date_from:'${m}-01', date_to:'${m}-31'})" title="View transactions">$${fmt(d ? d.spent : 0)}</td>`;
                });
                tHtml += '</tr>';
            });
            // Totals row
            tHtml += '<tr class="fw-bold" style="border-top:2px solid #58a6ff;"><td>TOTAL</td>';
            cardholders.forEach(ch => {
                const total = data[ch].reduce((s, d) => s + d.spent, 0);
                tHtml += `<td class="amount-negative">$${fmt(total)}</td>`;
            });
            tHtml += '</tr></tbody></table>';
            document.getElementById('cardholder-timeline-table').innerHTML = tHtml;
        }

        // ===== CHART.JS RENDERING =====
        let monthlyChart = null;
        let categoryChart = null;

        function renderDashboardCharts(stats) {
            const monthly = stats.monthly_trend || [];
            const categories = stats.by_category || [];

            // Monthly Cash Flow Bar Chart
            const mCtx = document.getElementById('monthly-chart');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(mCtx, {
                type: 'bar',
                data: {
                    labels: monthly.map(m => m.month),
                    datasets: [
                        { label: 'Deposits', data: monthly.map(m => m.deposits), backgroundColor: 'rgba(63,185,80,0.7)', borderRadius: 3 },
                        { label: 'Withdrawals', data: monthly.map(m => m.withdrawals), backgroundColor: 'rgba(248,81,73,0.7)', borderRadius: 3 },
                        { label: 'Transfers Out', data: monthly.map(m => m.transfers_out), backgroundColor: 'rgba(210,153,34,0.7)', borderRadius: 3 },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8b949e', font: { size: 11 } } } },
                    scales: {
                        x: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } },
                        y: { ticks: { color: '#8b949e', font: { size: 10 }, callback: v => '$' + (v / 1000).toFixed(0) + 'k' }, grid: { color: '#21262d' } }
                    },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            const month = monthly[idx].month;
                            drillToMonth(month);
                        }
                    }
                }
            });

            // Category Doughnut Chart
            const cCtx = document.getElementById('category-chart');
            if (categoryChart) categoryChart.destroy();
            const topCats = categories.filter(c => c.spent > 0).slice(0, 8);
            const colors = ['#f85149', '#d29922', '#58a6ff', '#3fb950', '#bc8cff', '#fd7e14', '#3d95ce', '#8b949e'];
            categoryChart = new Chart(cCtx, {
                type: 'doughnut',
                data: {
                    labels: topCats.map(c => c.category),
                    datasets: [{ data: topCats.map(c => c.spent), backgroundColor: colors.slice(0, topCats.length), borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#8b949e', font: { size: 10 }, boxWidth: 12, padding: 6 } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: $${fmt(ctx.raw)}` } }
                    },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const idx = activeEls[0].index;
                            const cat = topCats[idx].category;

                            const handler = window.createDrilldownHandler({
                                sourceTab: 'dashboard',
                                widgetId: 'category-chart',
                                defaultTarget: DrilldownTarget.TRANSACTIONS,
                                breadcrumbLabel: 'Dashboard',
                                breadcrumbStore: window.GlobalBreadcrumbs,
                                getState: () => FilterStore.getState(),
                                onLogEvent: logDrilldownEvent,
                                onNavigate: (target, nextFilters) => {
                                    FilterStore.replace(nextFilters);
                                    navigateTo(target.toLowerCase());
                                }
                            });

                            handler({ filters: { category: cat } });
                        }
                    }
                }
            });
        }

        // ===== RUNNING BALANCE PER ACCOUNT =====
        async function showRunningBalance(accountId, accountName) {
            const data = await api(`/api/accounts/${accountId}/balance`);
            let html = `<div class="card-dark mt-3 mb-3">
            <div class="card-header"><i class="fas fa-chart-area me-1"></i> Running Balance: ${esc(accountName)}
                <button class="btn btn-sm btn-outline-light py-0 px-1 float-end" onclick="this.closest('.card-dark').remove()"><i class="fas fa-times fa-xs"></i></button>
            </div>
            <div class="scrollable-table"><table class="table table-dark-custom"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Category</th><th>Balance</th></tr></thead><tbody>`;
            data.forEach(t => {
                html += `<tr>
                <td style="white-space:nowrap;font-size:0.75rem;">${t.trans_date}</td>
                <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(t.description)}</td>
                <td class="${t.amount < 0 ? 'amount-negative' : 'amount-positive'}">$${fmt(Math.abs(t.amount))}</td>
                <td>${t.category}</td>
                <td class="${t.running_balance < 0 ? 'amount-negative' : 'amount-positive'} fw-bold">$${fmt(Math.abs(t.running_balance))}</td>
            </tr>`;
            });
            if (!data.length) html += '<tr><td colspan="5" class="text-muted text-center py-3">No transactions for this account.</td></tr>';
            html += '</tbody></table></div></div>';
            document.getElementById('accounts-content').insertAdjacentHTML('beforeend', html);
        }

        // ===== ON POP STATE (Browser Back/Forward) =====
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page) {
                isNavigatingBack = true;
                window.FilterStore.replace(e.state.filters || {});
                navigateTo(e.state.page, true, false);
            }
        });

        // ===== AUTH =====
        async function fetchUserProfile() {
            try {
                const res = await fetch('/api/auth/me');
                if (res.ok) {
                    const user = await res.json();

                    // Sidebar
                    const sidebarInfo = document.getElementById('sidebar-user-info');
                    if (sidebarInfo) {
                        sidebarInfo.innerHTML = `
                            <div class="mt-2" style="color: #58a6ff; font-weight: 600; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: color 0.2s;" onmouseover="this.style.color='#79c0ff'" onmouseout="this.style.color='#58a6ff'" onclick="logout()" title="Click to sign out">
                                <span class="text-truncate" style="max-width: 180px;"><i class="fas fa-user-circle me-1"></i> ${user.email}</span>
                                <i class="fas fa-sign-out-alt ms-1 text-muted hover-white"></i>
                            </div>
                        `;
                    }

                    // Top Bar
                    const topProfile = document.getElementById('top-user-profile');
                    if (topProfile) {
                        topProfile.style.display = 'flex';
                        topProfile.innerHTML = `
                            <div style="color: #58a6ff; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: color 0.2s; display: flex; align-items: center;" onmouseover="this.style.color='#79c0ff'" onmouseout="this.style.color='#58a6ff'" onclick="logout()" title="Click to sign out">
                                <i class="fas fa-user-circle me-2 fs-5"></i>
                                <span>${user.email}</span>
                                <i class="fas fa-sign-out-alt ms-2 text-muted"></i>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch user', e);
            }
        }

        async function logout() {
            try {
                // 1. Clear local auth state entirely
                localStorage.removeItem('auth_token');
                sessionStorage.clear();

                // 2. Destroy Flask-Login session
                await fetch('/api/auth/logout', { method: 'POST' });

                // 3. Navigate back to login
                window.location.href = '/login';
            } catch (e) {
                console.error('Logout failed', e);
                window.location.href = '/login';
            }
        }

        // ===== INIT =====
        (async () => {
            fetchUserProfile();
            allCategories = await api('/api/categories');
            loadDashboard();
            updateAlertBadge();
            loadSavedFilters();
        })();
    </script>
</body>

</html>