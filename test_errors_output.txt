============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\github\business\Forensic_CPA_AI
plugins: anyio-4.12.1, mock-3.15.1
collected 8 items

tests\test_analytics.py FEE                                              [ 37%]
tests\test_categorization.py .E                                          [ 62%]
tests\test_docs.py .FF                                                   [100%]

=================================== ERRORS ====================================
_____________ ERROR at setup of test_query_builder_faceted_counts _____________

    @pytest.fixture(scope="module")
    def setup_database():
        # Use a test db to not pollute the real db
        os.environ['TESTING'] = 'true'
        init_db()
        conn = get_db()
    
        # Insert some dummy transactions
>       conn.execute('''
            INSERT INTO transactions (trans_date, description, amount, category, cardholder_name, is_personal, is_business, is_transfer, trans_type)
            VALUES
            ('2023-01-01', 'Test Business 1', -100.0, 'Business - Supplies', 'Alice', 0, 1, 0, 'debit'),
            ('2023-01-02', 'Test Business 2', -200.0, 'Business - Services', 'Bob', 0, 1, 0, 'debit'),
            ('2023-01-03', 'Test Personal 1', -50.0, 'Personal - Dining', 'Alice', 1, 0, 0, 'debit'),
            ('2023-01-04', 'Test Deposit', 500.0, 'Deposits', NULL, 0, 0, 0, 'credit')
        ''')
E       sqlite3.IntegrityError: NOT NULL constraint failed: transactions.user_id

tests\test_analytics.py:17: IntegrityError
________________ ERROR at setup of test_api_analytics_overview ________________

    @pytest.fixture(scope="module")
    def setup_database():
        # Use a test db to not pollute the real db
        os.environ['TESTING'] = 'true'
        init_db()
        conn = get_db()
    
        # Insert some dummy transactions
>       conn.execute('''
            INSERT INTO transactions (trans_date, description, amount, category, cardholder_name, is_personal, is_business, is_transfer, trans_type)
            VALUES
            ('2023-01-01', 'Test Business 1', -100.0, 'Business - Supplies', 'Alice', 0, 1, 0, 'debit'),
            ('2023-01-02', 'Test Business 2', -200.0, 'Business - Services', 'Bob', 0, 1, 0, 'debit'),
            ('2023-01-03', 'Test Personal 1', -50.0, 'Personal - Dining', 'Alice', 1, 0, 0, 'debit'),
            ('2023-01-04', 'Test Deposit', 500.0, 'Deposits', NULL, 0, 0, 0, 'credit')
        ''')
E       sqlite3.IntegrityError: NOT NULL constraint failed: transactions.user_id

tests\test_analytics.py:17: IntegrityError
_______________ ERROR at setup of test_api_categorize_endpoint ________________

    @pytest.fixture(scope="module")
    def setup_test_client():
        os.environ['TESTING'] = 'true'
        # Mock Auth for API endpoints
        os.environ['UPLOAD_AUTH_TOKEN'] = 'secret-test-token'
    
        init_db()
    
        # Pre-seed a document extraction
>       doc_id = add_document('test_statement.pdf', '/fake/path.pdf', 'pdf', 'bank_statement', None)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_categorization.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

user_id = 'test_statement.pdf', filename = '/fake/path.pdf'
original_path = 'pdf', file_type = 'bank_statement', doc_category = None
account_id = None, statement_start = None, statement_end = None, notes = None

    def add_document(user_id, filename, original_path, file_type, doc_category, account_id=None, statement_start=None, statement_end=None, notes=None):
        conn = get_db()
        cursor = conn.cursor()
>       cursor.execute(
            "INSERT INTO documents (user_id, filename, original_path, file_type, doc_category, account_id, statement_start_date, statement_end_date, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
            (user_id, filename, original_path, file_type, doc_category, account_id, statement_start, statement_end, notes)
        )
E       sqlite3.OperationalError: database is locked

database.py:504: OperationalError
================================== FAILURES ===================================
_______________________ test_query_builder_where_clause _______________________

    def test_query_builder_where_clause():
        # Test empty filters
        qb = QueryBuilder({})
        where, params = qb.get_where_clause()
>       assert where == "1=1"
E       AssertionError: assert 'user_id = ?' == '1=1'
E         
E         - 1=1
E         + user_id = ?

tests\test_analytics.py:34: AssertionError
________________________ test_api_docs_upload_success _________________________

setup_test_client = <FlaskClient <Flask 'app'>>
mocker = <pytest_mock.plugin.MockerFixture object at 0x000002039BB19850>

    def test_api_docs_upload_success(setup_test_client, mocker):
        client = setup_test_client
    
        # Mock the Azure adapter to avoid network calls during tests
        mock_analyze = mocker.patch('document_analyzer.AzureDocumentIntelligenceAdapter.analyze_document')
        mock_analyze.return_value = {"content": "mock extracted content", "pages": []}
    
        with open('test_upload.pdf', 'rb') as f:
            data = {'file': (f, 'test_upload.pdf')}
            headers = {'Authorization': 'Bearer secret-test-token'}
>           response = client.post('/api/docs/upload', data=data, headers=headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_docs.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv\Lib\site-packages\werkzeug\test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\testing.py:234: in open
    response = super().open(
.venv\Lib\site-packages\werkzeug\test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\werkzeug\test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\werkzeug\test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\flask\app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app.py:164: in decorated
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
app.py:346: in api_docs_upload
    doc_id = add_document(g.user.id, file.filename, filepath, ext, 'unknown', None)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

user_id = 1, filename = 'test_upload.pdf'
original_path = 'C:\\dev\\github\\business\\Forensic_CPA_AI\\uploads\\9c61570ac3d5435796ae081fef827b6b.pdf'
file_type = 'pdf', doc_category = 'unknown', account_id = None
statement_start = None, statement_end = None, notes = None

    def add_document(user_id, filename, original_path, file_type, doc_category, account_id=None, statement_start=None, statement_end=None, notes=None):
        conn = get_db()
        cursor = conn.cursor()
>       cursor.execute(
            "INSERT INTO documents (user_id, filename, original_path, file_type, doc_category, account_id, statement_start_date, statement_end_date, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
            (user_id, filename, original_path, file_type, doc_category, account_id, statement_start, statement_end, notes)
        )
E       sqlite3.OperationalError: database is locked

database.py:504: OperationalError
______________________________ test_api_docs_get ______________________________

setup_test_client = <FlaskClient <Flask 'app'>>

    def test_api_docs_get(setup_test_client):
        client = setup_test_client
        # Let's get the doc we just uploaded (should be ID 1 if DB is clean)
        response = client.get('/api/docs/1')
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <WrapperTestResponse streamed [401 UNAUTHORIZED]>.status_code

tests\test_docs.py:71: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_analytics.py::test_query_builder_where_clause - AssertionEr...
FAILED tests/test_docs.py::test_api_docs_upload_success - sqlite3.Operational...
FAILED tests/test_docs.py::test_api_docs_get - assert 401 == 200
ERROR tests/test_analytics.py::test_query_builder_faceted_counts - sqlite3.In...
ERROR tests/test_analytics.py::test_api_analytics_overview - sqlite3.Integrit...
ERROR tests/test_categorization.py::test_api_categorize_endpoint - sqlite3.Op...
=================== 3 failed, 2 passed, 3 errors in 12.97s ====================
